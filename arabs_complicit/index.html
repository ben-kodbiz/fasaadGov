<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arab Complicity Sunburst Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1976d2;
            --secondary-color: #dc004e;
            --background-color: #fafafa;
            --surface-color: #ffffff;
            --text-color: #1c1b1f;
            --text-secondary: #49454f;
            --border-color: #79747e;
            --shadow: rgba(0, 0, 0, 0.12);
            --shadow-dark: rgba(0, 0, 0, 0.24);
            
            /* Relationship colors */
            --direct-israel: #e53e3e;
            --indirect-israel: #fd9853;
            --direct-us: #3182ce;
            --indirect-us: #63b3ed;
            --investment-high: #38a169;
            --investment-medium: #68d391;
            --investment-low: #c6f6d5;
        }

        [data-theme="dark"] {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e6e1e5;
            --text-secondary: #cac4d0;
            --border-color: #938f99;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .header {
            background: var(--surface-color);
            padding: 20px;
            box-shadow: 0 2px 4px var(--shadow);
            text-align: center;
        }

        .header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 2rem;
            font-weight: 500;
        }

        .header p {
            margin: 10px 0 0 0;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .controls {
            background: var(--surface-color);
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .select, .btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .visualization-container {
            display: flex;
            gap: 20px;
            margin: 20px;
        }

        .sunburst-container {
            flex: 2;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
            padding: 20px;
            min-height: 600px;
        }

        .info-panel {
            flex: 1;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .info-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .legend {
            background: var(--surface-color);
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .legend h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .tooltip {
            position: absolute;
            background: var(--surface-color);
            color: var(--text-color);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 16px var(--shadow-dark);
            pointer-events: none;
            font-size: 0.875rem;
            max-width: 300px;
            z-index: 1000;
            border: 1px solid var(--border-color);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tooltip-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .tooltip-content {
            line-height: 1.4;
        }

        .sunburst-path {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sunburst-path:hover {
            stroke: var(--text-color);
            stroke-width: 2px;
        }

        .sunburst-text {
            font-size: 12px;
            font-weight: 500;
            text-anchor: middle;
            pointer-events: none;
            fill: var(--text-color);
        }

        @media (max-width: 768px) {
            .visualization-container {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .legend-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŒ… Arab Complicity Analysis</h1>
        <p>Interactive visualization of Arab countries' relationships with Israel and the United States</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label class="control-label">View Mode</label>
            <select id="viewMode" class="select">
                <option value="relationships">Relationship Types</option>
                <option value="investments">Investment Levels</option>
                <option value="timeline">Timeline View</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Focus</label>
            <select id="focusFilter" class="select">
                <option value="all">All Countries</option>
                <option value="direct">Direct Ties Only</option>
                <option value="indirect">Indirect Ties Only</option>
                <option value="abraham">Abraham Accords</option>
            </select>
        </div>
        <button id="resetView" class="btn">Reset View</button>
    </div>

    <div class="visualization-container">
        <div class="sunburst-container">
            <div id="sunburst"></div>
        </div>
        <div class="info-panel">
            <h3>Country Information</h3>
            <div id="countryInfo">
                <p>Click on a segment to view detailed information about a country's relationships and investments.</p>
            </div>
        </div>
    </div>

    <div class="legend">
        <h3>Legend</h3>
        <div class="legend-grid">
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--direct-israel);"></div>
                <span>Direct ties with Israel</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--indirect-israel);"></div>
                <span>Indirect ties with Israel</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--direct-us);"></div>
                <span>Direct ties with US</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--indirect-us);"></div>
                <span>Indirect ties with US</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--investment-high);"></div>
                <span>High investment (>$100B)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--investment-medium);"></div>
                <span>Medium investment ($1B-$100B)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--investment-low);"></div>
                <span>Low investment (<$1B)</span>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Global variables
        let data = {};
        let investmentData = {};
        let currentView = 'relationships';
        let currentFocus = 'all';
        
        // Dimensions
        const width = 600;
        const height = 600;
        const radius = Math.min(width, height) / 2;

        // Create SVG
        const svg = d3.select("#sunburst")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);

        // Tooltip
        const tooltip = d3.select("#tooltip");

        // Load data
        Promise.all([
            d3.json("arabs_complicit.json"),
            d3.json("arabs_investment.json")
        ]).then(([complicitData, investData]) => {
            data = complicitData;
            investmentData = investData;
            initializeVisualization();
        }).catch(error => {
            console.error("Error loading data:", error);
            d3.select("#sunburst").html(`
                <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                    <h3>Error loading data</h3>
                    <p>Please check the console for details.</p>
                </div>
            `);
        });

        function initializeVisualization() {
            updateVisualization();
            setupEventListeners();
        }

        function setupEventListeners() {
            d3.select("#viewMode").on("change", function() {
                currentView = this.value;
                updateVisualization();
            });

            d3.select("#focusFilter").on("change", function() {
                currentFocus = this.value;
                updateVisualization();
            });

            d3.select("#resetView").on("click", function() {
                currentView = 'relationships';
                currentFocus = 'all';
                d3.select("#viewMode").property("value", "relationships");
                d3.select("#focusFilter").property("value", "all");
                updateVisualization();
            });
        }

        function processData() {
            const countries = data.countries.filter(country => {
                if (currentFocus === 'all') return true;
                if (currentFocus === 'direct') return country.ties_with_israel === 'Direct';
                if (currentFocus === 'indirect') return country.ties_with_israel === 'Indirect';
                if (currentFocus === 'abraham') {
                    return country.details.agreements.some(agreement => 
                        agreement.name === 'Abraham Accords'
                    );
                }
                return true;
            });

            // Create hierarchical structure
            const root = {
                name: "Arab Countries",
                children: []
            };

            if (currentView === 'relationships') {
                // Group by relationship types
                const directIsrael = countries.filter(c => c.ties_with_israel === 'Direct');
                const indirectIsrael = countries.filter(c => c.ties_with_israel === 'Indirect');

                if (directIsrael.length > 0) {
                    root.children.push({
                        name: "Direct Israel Ties",
                        children: directIsrael.map(country => ({
                            name: country.name,
                            data: country,
                            value: 1
                        })),
                        type: 'direct-israel'
                    });
                }

                if (indirectIsrael.length > 0) {
                    root.children.push({
                        name: "Indirect Israel Ties",
                        children: indirectIsrael.map(country => ({
                            name: country.name,
                            data: country,
                            value: 1
                        })),
                        type: 'indirect-israel'
                    });
                }
            } else if (currentView === 'investments') {
                // Group by investment levels
                const investmentLevels = {
                    high: [],
                    medium: [],
                    low: []
                };

                countries.forEach(country => {
                    const investCountry = investmentData.countries.find(c => c.name === country.name);
                    if (investCountry) {
                        const usTotal = parseInvestmentAmount(investCountry.investments.united_states.total_estimate_1995_2025);
                        if (usTotal > 100) {
                            investmentLevels.high.push({name: country.name, data: country, investment: usTotal, value: usTotal});
                        } else if (usTotal > 1) {
                            investmentLevels.medium.push({name: country.name, data: country, investment: usTotal, value: usTotal});
                        } else {
                            investmentLevels.low.push({name: country.name, data: country, investment: usTotal, value: Math.max(0.1, usTotal)});
                        }
                    } else {
                        investmentLevels.low.push({name: country.name, data: country, investment: 0, value: 0.1});
                    }
                });

                if (investmentLevels.high.length > 0) {
                    root.children.push({
                        name: "High Investment (>$100B)",
                        children: investmentLevels.high,
                        type: 'investment-high'
                    });
                }
                if (investmentLevels.medium.length > 0) {
                    root.children.push({
                        name: "Medium Investment ($1B-$100B)",
                        children: investmentLevels.medium,
                        type: 'investment-medium'
                    });
                }
                if (investmentLevels.low.length > 0) {
                    root.children.push({
                        name: "Low Investment (<$1B)",
                        children: investmentLevels.low,
                        type: 'investment-low'
                    });
                }
            }

            return root;
        }

        function parseInvestmentAmount(amountStr) {
            if (!amountStr) return 0;
            const match = amountStr.match(/(\d+(?:\.\d+)?)\s*([BM]?)/i);
            if (!match) return 0;
            
            const num = parseFloat(match[1]);
            const unit = match[2].toUpperCase();
            
            if (unit === 'B') return num;
            if (unit === 'M') return num / 1000;
            return num / 1000000; // Assume millions if no unit
        }

        function getColor(d) {
            if (d.data.type) {
                switch (d.data.type) {
                    case 'direct-israel': return 'var(--direct-israel)';
                    case 'indirect-israel': return 'var(--indirect-israel)';
                    case 'investment-high': return 'var(--investment-high)';
                    case 'investment-medium': return 'var(--investment-medium)';
                    case 'investment-low': return 'var(--investment-low)';
                }
            }
            
            if (d.parent && d.parent.data.type) {
                const parentColor = getColor(d.parent);
                return d3.color(parentColor).brighter(0.3);
            }
            
            return 'var(--primary-color)';
        }

        function updateVisualization() {
            const hierarchyData = processData();
            
            // Clear previous visualization
            svg.selectAll("*").remove();

            if (!hierarchyData.children || hierarchyData.children.length === 0) {
                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("dy", "0.35em")
                    .style("font-size", "16px")
                    .style("fill", "var(--text-secondary)")
                    .text("No data available for current filter");
                return;
            }

            // Create hierarchy
            const root = d3.hierarchy(hierarchyData)
                .sum(d => d.value || 1)
                .sort((a, b) => b.value - a.value);

            // Create partition layout
            const partition = d3.partition()
                .size([2 * Math.PI, radius]);

            partition(root);

            // Create arc generator
            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .innerRadius(d => d.y0)
                .outerRadius(d => d.y1);

            // Draw arcs
            const paths = svg.selectAll("path")
                .data(root.descendants().filter(d => d.depth > 0))
                .enter()
                .append("path")
                .attr("class", "sunburst-path")
                .attr("d", arc)
                .style("fill", getColor)
                .style("stroke", "var(--surface-color)")
                .style("stroke-width", "2px")
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
                .on("click", handleClick);

            // Add text labels
            const texts = svg.selectAll("text")
                .data(root.descendants().filter(d => d.depth > 0 && (d.x1 - d.x0) > 0.1))
                .enter()
                .append("text")
                .attr("class", "sunburst-text")
                .attr("transform", d => {
                    const angle = (d.x0 + d.x1) / 2;
                    const radius = (d.y0 + d.y1) / 2;
                    return `rotate(${(angle * 180 / Math.PI - 90)}) translate(${radius},0) rotate(${angle > Math.PI ? 180 : 0})`;
                })
                .attr("dy", "0.35em")
                .text(d => {
                    const availableWidth = (d.x1 - d.x0) * (d.y0 + d.y1) / 2;
                    return availableWidth > 50 ? d.data.name : "";
                });

            // Add center label
            svg.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .style("font-size", "16px")
                .style("font-weight", "500")
                .style("fill", "var(--primary-color)")
                .text("Arab Countries");
        }

        function handleMouseOver(event, d) {
            tooltip.style("opacity", 1);
            
            let content = `<div class="tooltip-title">${d.data.name}</div>`;
            
            if (d.data.data) {
                const country = d.data.data;
                content += `<div class="tooltip-content">`;
                content += `<strong>Israel ties:</strong> ${country.ties_with_israel}<br>`;
                content += `<strong>US ties:</strong> ${country.ties_with_us}<br>`;
                
                if (country.details.agreements.length > 0) {
                    content += `<strong>Key agreements:</strong> ${country.details.agreements.map(a => a.name).join(", ")}<br>`;
                }
                
                const investCountry = investmentData.countries.find(c => c.name === country.name);
                if (investCountry) {
                    content += `<strong>US investment:</strong> ${investCountry.investments.united_states.total_estimate_1995_2025}`;
                }
                
                content += `</div>`;
            }
            
            tooltip.html(content)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function handleMouseOut() {
            tooltip.style("opacity", 0);
        }

        function handleClick(event, d) {
            if (d.data.data) {
                showCountryInfo(d.data.data);
            }
        }

        function showCountryInfo(country) {
            const investCountry = investmentData.countries.find(c => c.name === country.name);
            
            let html = `
                <h3>${country.name}</h3>
                <div style="margin-bottom: 15px;">
                    <strong>Relationship Status:</strong><br>
                    â€¢ Israel: ${country.ties_with_israel}<br>
                    â€¢ United States: ${country.ties_with_us}
                </div>
            `;
            
            if (country.details.agreements.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <strong>Key Agreements:</strong><br>
                        ${country.details.agreements.map(agreement => 
                            `â€¢ ${agreement.name} (${agreement.year})`
                        ).join('<br>')}
                    </div>
                `;
            }
            
            if (investCountry) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <strong>US Investment (1995-2025):</strong><br>
                        ${investCountry.investments.united_states.total_estimate_1995_2025}
                    </div>
                `;
                
                if (investCountry.investments.israel.total_estimate_1995_2025 !== "None recorded." && 
                    investCountry.investments.israel.total_estimate_1995_2025 !== "Negligible.") {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <strong>Israel Investment (1995-2025):</strong><br>
                            ${investCountry.investments.israel.total_estimate_1995_2025}
                        </div>
                    `;
                }
            }
            
            if (country.details.public_sentiment) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <strong>Public Sentiment:</strong><br>
                        ${country.details.public_sentiment}
                    </div>
                `;
            }
            
            d3.select("#countryInfo").html(html);
        }
    </script>
</body>
</html>