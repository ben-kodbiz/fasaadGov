<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arab Complicity Sunburst Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Material Design 3 Colors */
            --primary-color: #1976d2;
            --primary-variant: #1565c0;
            --secondary-color: #03dac6;
            --secondary-variant: #018786;
            --background-color: #fafafa;
            --surface-color: #ffffff;
            --surface-variant: #f5f5f5;
            --text-color: #1c1b1f;
            --text-secondary: #49454f;
            --border-color: #79747e;
            --shadow: rgba(0, 0, 0, 0.12);
            --shadow-dark: rgba(0, 0, 0, 0.24);

            /* Material Design relationship colors - no black */
            --direct-israel: #d32f2f;
            /* Material Red 700 */
            --indirect-israel: #ff9800;
            /* Material Orange 500 */
            --direct-us: #1976d2;
            /* Material Blue 700 */
            --indirect-us: #42a5f5;
            /* Material Blue 400 */
            --investment-high: #388e3c;
            /* Material Green 700 */
            --investment-medium: #66bb6a;
            /* Material Green 400 */
            --investment-low: #a5d6a7;
            /* Material Green 200 */

            /* Additional Material colors */
            --error-color: #b00020;
            --warning-color: #ff6f00;
            --success-color: #00c853;
            --info-color: #2196f3;
        }

        [data-theme="dark"] {
            /* Material Design 3 Dark Theme */
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --surface-variant: #2d2d2d;
            --text-color: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #666666;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.5);

            /* Adjusted colors for dark theme - brighter for better contrast */
            --direct-israel: #ff5252;
            /* Material Red 400 - brighter */
            --indirect-israel: #ffb74d;
            /* Material Orange 300 */
            --direct-us: #42a5f5;
            /* Material Blue 400 */
            --indirect-us: #90caf9;
            /* Material Blue 200 */
            --investment-high: #66bb6a;
            /* Material Green 400 */
            --investment-medium: #a5d6a7;
            /* Material Green 200 */
            --investment-low: #c8e6c9;
            /* Material Green 100 */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .header {
            background: var(--surface-color);
            padding: 20px;
            box-shadow: 0 2px 4px var(--shadow);
            text-align: center;
        }

        .header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 2rem;
            font-weight: 500;
        }

        .header p {
            margin: 10px 0 0 0;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .controls {
            background: var(--surface-color);
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .select,
        .btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .visualization-container {
            display: flex;
            gap: 20px;
            margin: 20px;
        }

        .sunburst-container {
            flex: 2;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
            padding: 20px;
            min-height: 600px;
        }

        .info-panel {
            flex: 1;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .info-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .legend {
            background: var(--surface-color);
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .legend h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .tooltip {
            position: absolute;
            background: var(--surface-color);
            color: var(--text-color);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 16px var(--shadow-dark);
            pointer-events: none;
            font-size: 0.875rem;
            max-width: 300px;
            z-index: 1000;
            border: 1px solid var(--border-color);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tooltip-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .tooltip-content {
            line-height: 1.4;
        }

        .sunburst-path {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sunburst-path:hover {
            stroke: var(--text-color);
            stroke-width: 2px;
        }

        .sunburst-text {
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
            pointer-events: none;
            fill: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        [data-theme="dark"] .sunburst-text {
            fill: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
        }

        @media (max-width: 768px) {
            .visualization-container {
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .legend-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üåÖ Arab Complicity Analysis</h1>
        <p>Interactive visualization of Arab countries' relationships with Israel and the United States</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label class="control-label">View Mode</label>
            <select id="viewMode" class="select">
                <option value="relationships">Relationship Types</option>
                <option value="investments">Investment Levels</option>
                <option value="timeline">Timeline View</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Focus</label>
            <select id="focusFilter" class="select">
                <option value="all">All Countries</option>
                <option value="direct">Direct Ties Only</option>
                <option value="indirect">Indirect Ties Only</option>
                <option value="abraham">Abraham Accords</option>
            </select>
        </div>
        <button id="resetView" class="btn">Reset View</button>
        <button id="themeToggle" class="btn" style="background: var(--secondary-color);">üåô Dark Mode</button>
        <button id="debugInvestments" class="btn" style="background: var(--warning-color);">üîç Debug</button>
    </div>

    <div class="visualization-container">
        <div class="sunburst-container">
            <div id="sunburst"></div>
        </div>
        <div class="info-panel">
            <h3>Country Information</h3>
            <div id="countryInfo">
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">üéØ Getting Started</h4>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        Click on any segment in the sunburst chart to view detailed information about a country's
                        relationships and investments.
                    </p>
                    <div
                        style="background: var(--surface-variant); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong style="color: var(--text-color);">üí° Tips:</strong><br>
                        <small style="line-height: 1.4;">
                            ‚Ä¢ Hover over segments for quick info<br>
                            ‚Ä¢ Use the controls above to change views<br>
                            ‚Ä¢ Try different focus filters<br>
                            ‚Ä¢ Toggle dark mode for better viewing
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="legend">
        <h3>Legend</h3>
        <div class="legend-grid">
            <div class="legend-item">
                <div class="legend-color"
                    style="background-color: var(--direct-israel); box-shadow: 0 2px 4px rgba(211, 47, 47, 0.3);"></div>
                <span>üáÆüá± Direct ties with Israel</span>
            </div>
            <div class="legend-item">
                <div class="legend-color"
                    style="background-color: var(--indirect-israel); box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);">
                </div>
                <span>üáÆüá± Indirect ties with Israel</span>
            </div>
            <div class="legend-item">
                <div class="legend-color"
                    style="background-color: var(--direct-us); box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3);"></div>
                <span>üá∫üá∏ Direct ties with US</span>
            </div>
            <div class="legend-item">
                <div class="legend-color"
                    style="background-color: var(--indirect-us); box-shadow: 0 2px 4px rgba(66, 165, 245, 0.3);"></div>
                <span>üá∫üá∏ Indirect ties with US</span>
            </div>
            <div class="legend-item">
                <div class="legend-color"
                    style="background-color: var(--investment-high); box-shadow: 0 2px 4px rgba(56, 142, 60, 0.3);">
                </div>
                <span>üí∞ High investment (>$100B)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color"
                    style="background-color: var(--investment-medium); box-shadow: 0 2px 4px rgba(102, 187, 106, 0.3);">
                </div>
                <span>üí∞ Medium investment ($1B-$100B)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color"
                    style="background-color: var(--investment-low); box-shadow: 0 2px 4px rgba(165, 214, 167, 0.3);">
                </div>
                <span>üí∞ Low investment (<$1B)< /span>
            </div>
        </div>

        <div
            style="margin-top: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px; text-align: center;">
            <strong style="color: var(--primary-color);">üìö Evidence-Based Analysis</strong><br>
            <small style="color: var(--text-secondary); line-height: 1.4;">
                All information is backed by credible sources including government documents, academic studies, and
                reputable news organizations.
                Click on any country segment to view detailed sources and evidence links.
            </small>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Global variables
        let data = {};
        let investmentData = {};
        let currentView = 'relationships';
        let currentFocus = 'all';

        // Dimensions
        const width = 600;
        const height = 600;
        const radius = Math.min(width, height) / 2;

        // Create SVG
        const svg = d3.select("#sunburst")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);

        // Tooltip
        const tooltip = d3.select("#tooltip");

        // URL validation function to check for broken links
        function validateUrl(url) {
            try {
                new URL(url);
                return !url.includes('[](') && !url.includes('[]') && url.startsWith('http');
            } catch {
                return false;
            }
        }

        // Function to clean malformed URLs
        function cleanUrl(url) {
            if (!url) return '';
            // Remove malformed fragments like [](...)
            return url.split('[](')[0].split('[]')[0].trim();
        }

        // Embedded data to avoid CORS issues - URLs cleaned and validated
        const complicitData = {
            "countries": [
                {
                    "name": "Egypt",
                    "ties_with_israel": "Direct",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [
                            { "name": "Camp David Accords", "year": 1978, "description": "Framework for peace between Egypt and Israel, leading to the 1979 peace treaty." },
                            { "name": "Egypt-Israel Peace Treaty", "year": 1979, "description": "Formalized diplomatic relations, with Israel withdrawing from Sinai." }
                        ],
                        "cooperation": {
                            "israel": "Security coordination in Sinai, Gaza border control, and diplomatic relations with embassies in Cairo and Tel Aviv.",
                            "us": "Receives ~$1.3 billion annually in US military aid; collaborates on counterterrorism and regional stability."
                        },
                        "public_sentiment": "Only 5% of Egyptians support normalization with Israel (Arab Barometer, 2022). Public protests against Israel's Gaza policies are common, but the government prioritizes strategic ties.",
                        "sources": [
                            { "title": "Camp David Accords, US State Department", "url": "https://www.state.gov/the-camp-david-accords/" },
                            { "title": "Arab Barometer 2022 Survey", "url": "https://www.arabbarometer.org/surveys/ab-wave-vii/" },
                            { "title": "Egypt-Israel Peace Treaty", "url": "https://www.presidency.ucsb.edu/documents/the-camp-david-accords" }
                        ]
                    }
                },
                {
                    "name": "Jordan",
                    "ties_with_israel": "Direct",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [
                            { "name": "Israel-Jordan Peace Treaty", "year": 1994, "description": "Established diplomatic relations, water-sharing agreements, and security cooperation." }
                        ],
                        "cooperation": {
                            "israel": "Water sharing (Jordan River), counterterrorism, and airspace defense (e.g., intercepting Iranian drones in 2024).",
                            "us": "Receives over $1 billion annually in US aid; hosts US military bases and conducts joint exercises."
                        },
                        "public_sentiment": "Normalization support is low at 5% (Arab Barometer, 2022). Pro-Palestinian protests are frequent, especially post-October 2023.",
                        "sources": [
                            { "title": "Israel-Jordan Peace Treaty, UN", "url": "https://peacemaker.un.org/sites/peacemaker.un.org/files/IL%20JO_941026_PeaceTreatyIsraelJordan.pdf" },
                            { "title": "US-Jordan Relations, US Embassy", "url": "https://jo.usembassy.gov/our-relationship/" },
                            { "title": "Arab Barometer 2022 Survey", "url": "https://www.arabbarometer.org/surveys/ab-wave-vii/" },
                            { "title": "Jordan's Role in Regional Security", "url": "https://www.csis.org/analysis/jordans-role-regional-security" }
                        ]
                    }
                },
                {
                    "name": "United Arab Emirates",
                    "ties_with_israel": "Direct",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [
                            { "name": "Abraham Accords", "year": 2020, "description": "Normalized diplomatic and economic relations with Israel." },
                            { "name": "Comprehensive Economic Partnership Agreement", "year": 2022, "description": "Boosted trade and investment between UAE and Israel." }
                        ],
                        "cooperation": {
                            "israel": "Direct flights, trade (Israel's second-largest Middle East trading partner), and technology partnerships.",
                            "us": "Hosts US military bases; US brokered Abraham Accords, promising F-35 jets."
                        },
                        "public_sentiment": "67% of Arabs view UAE's Gaza stance negatively (2023 survey). Domestic support for normalization is higher but still limited.",
                        "sources": [
                            { "title": "Abraham Accords, US State Department", "url": "https://www.state.gov/the-abraham-accords/" },
                            { "title": "UAE-Israel Trade Agreement", "url": "https://www.trade.gov/country-commercial-guides/israel-trade-agreements" },
                            { "title": "Crisis Group: UAE-Israel Relations", "url": "https://www.crisisgroup.org/middle-east-north-africa/gulf-and-arabian-peninsula/united-arab-emirates/uae-israel-and-test-influence" },
                            { "title": "UAE Embassy in Israel", "url": "https://www.mofaic.gov.ae/en/missions/tel-aviv" }
                        ]
                    }
                },
                {
                    "name": "Bahrain",
                    "ties_with_israel": "Direct",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [
                            { "name": "Abraham Accords", "year": 2020, "description": "Formalized diplomatic and economic ties with Israel." }
                        ],
                        "cooperation": {
                            "israel": "Diplomatic relations, trade, and security coordination.",
                            "us": "Hosts US Navy's Fifth Fleet; strong defense partnership."
                        },
                        "public_sentiment": "Significant domestic opposition, particularly from Shia communities, limits public support for normalization.",
                        "sources": [
                            { "title": "Abraham Accords, US State Department", "url": "https://www.state.gov/the-abraham-accords/" },
                            { "title": "US-Bahrain Relations, US Embassy", "url": "https://bh.usembassy.gov/our-relationship/" },
                            { "title": "Bahrain-Israel Normalization", "url": "https://www.reuters.com/article/us-israel-bahrain-usa-idUSKBN26630V" }
                        ]
                    }
                },
                {
                    "name": "Morocco",
                    "ties_with_israel": "Direct",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [
                            { "name": "Abraham Accords", "year": 2020, "description": "Restored diplomatic ties with Israel, including trade and tourism." }
                        ],
                        "cooperation": {
                            "israel": "Trade, tourism, direct flights; Israel recognized Morocco's Western Sahara claim.",
                            "us": "Receives US military and economic aid; US supported Western Sahara claim."
                        },
                        "public_sentiment": "Support for normalization fell from 31% in 2022 to 13% post-October 2023 (Arab Barometer).",
                        "sources": [
                            { "title": "Abraham Accords, US State Department", "url": "https://www.state.gov/the-abraham-accords/" },
                            { "title": "Morocco-US Relations, US Embassy", "url": "https://ma.usembassy.gov/our-relationship/" },
                            { "title": "Arab Barometer Survey", "url": "https://www.arabbarometer.org/surveys/ab-wave-vii/" },
                            { "title": "Morocco-Israel Normalization", "url": "https://www.reuters.com/article/israel-morocco-usa-idUSKBN28K1LZ" }
                        ]
                    }
                },
                {
                    "name": "Sudan",
                    "ties_with_israel": "Direct",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [
                            { "name": "Abraham Accords", "year": 2020, "description": "Agreed to normalize relations with Israel, though implementation is stalled." }
                        ],
                        "cooperation": {
                            "israel": "Limited due to internal conflict; initial steps toward diplomatic ties.",
                            "us": "US removed Sudan from terrorism list and provided aid post-normalization agreement."
                        },
                        "public_sentiment": "Widespread opposition to normalization; ongoing conflict limits public discourse.",
                        "sources": [
                            { "title": "Abraham Accords, US State Department", "url": "https://www.state.gov/the-abraham-accords/" },
                            { "title": "Sudan Terrorism List Removal", "url": "https://www.state.gov/rescission-of-sudan-as-a-state-sponsor-of-terrorism/" },
                            { "title": "Sudan-Israel Normalization", "url": "https://www.reuters.com/article/us-israel-sudan-usa-idUSKBN27I1I8" }
                        ]
                    }
                },
                {
                    "name": "Saudi Arabia",
                    "ties_with_israel": "Indirect",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [],
                        "cooperation": {
                            "israel": "Tacit intelligence sharing, airspace access (e.g., 2024 Iranian drone defense); no formal ties.",
                            "us": "Major US ally; hosts US military assets and purchases billions in US weapons."
                        },
                        "public_sentiment": "Strong public opposition to normalization; 96% prioritize Palestinian cause (2023 poll).",
                        "sources": [
                            { "title": "Saudi Arabia‚ÄìUnited States Relations", "url": "https://en.wikipedia.org/wiki/Saudi_Arabia%E2%80%93United_States_relations" },
                            { "title": "US-Saudi Defense Cooperation Analysis", "url": "https://www.stimson.org/2025/the-largest-defense-cooperation-agreement-in-u-s-history-may-not-add-up-to-expectations/" },
                            { "title": "Congressional Research Service: Saudi Arabia Relations", "url": "https://www.congress.gov/crs-product/R48162#:~:text=Regarding%20Congress's%20powers%20and%20prerogatives,its%20duties%20and%20functions%20fully." }
                        ]
                    }
                },
                {
                    "name": "Oman",
                    "ties_with_israel": "Indirect",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [],
                        "cooperation": {
                            "israel": "Backchannel communication; hosted Israeli officials (e.g., Netanyahu in 2018).",
                            "us": "Hosts US military facilities; strong defense and trade ties."
                        },
                        "public_sentiment": "Limited support for normalization; Oman's neutral stance moderates public debate.",
                        "sources": [
                            { "title": "US-Oman Relations, US Embassy", "url": "https://om.usembassy.gov/our-relationship/" },
                            { "title": "Netanyahu Oman Visit 2018", "url": "https://www.reuters.com/article/us-israel-oman-netanyahu-idUSKCN1MZ0Q7" },
                            { "title": "Oman's Diplomatic Role", "url": "https://www.brookings.edu/articles/omans-unique-foreign-policy-the-gulf-states-go-to-mediator/" }
                        ]
                    }
                },
                {
                    "name": "Qatar",
                    "ties_with_israel": "Indirect",
                    "ties_with_us": "Direct",
                    "details": {
                        "agreements": [],
                        "cooperation": {
                            "israel": "Backchannel coordination for Gaza aid; hosted Hamas office with Israel's approval.",
                            "us": "Hosts Al Udeid Air Base; key US partner in defense and diplomacy."
                        },
                        "public_sentiment": "Strong public support for Palestine; normalization is unpopular.",
                        "sources": [
                            { "title": "US-Qatar Relations, US Embassy", "url": "https://qa.usembassy.gov/our-relationship/" },
                            { "title": "Qatar Gaza Mediation", "url": "https://www.reuters.com/world/middle-east/qatar-key-mediator-israel-hamas-talks-2023-10-12/" },
                            { "title": "Al Udeid Air Base", "url": "https://www.centcom.mil/AREA-OF-RESPONSIBILITY/Countries/qatar/" },
                            { "title": "Qatar's Regional Diplomacy", "url": "https://www.cfr.org/backgrounder/qatar-gulf-crisis-foreign-policy" }
                        ]
                    }
                }
            ]
        };

        const investData = {
            "countries": [
                {
                    "name": "Saudi Arabia",
                    "investments": {
                        "united_states": { "total_estimate_1995_2025": "Over $800 billion (conservative estimate, including government and private investments)." },
                        "israel": { "total_estimate_1995_2025": "Under $1 billion, mostly post-2020 and indirect." }
                    },
                    "key_investments": [
                        { "year": 1988, "amount": "$2 billion", "description": "Saudi Arabia purchased a 50% stake in Texaco's US refining and marketing operations.", "source": "https://www.nytimes.com/1990/04/30/business/arab-investment-overseas-a-vast-empire.html" },
                        { "year": 2016, "amount": "$3.5 billion", "description": "Saudi Arabia's PIF invested in Uber, marking a significant tech sector entry.", "source": "" },
                        { "year": 2017, "amount": "$20 billion", "description": "PIF committed to Blackstone's US infrastructure fund.", "source": "https://www.blackstone.com/news/press/blackstone-and-saudi-arabias-public-investment-fund-announce-anchor-commitment-to-new-infrastructure-fund/" },
                        { "year": 2019, "amount": "$45 billion", "description": "PIF invested in SoftBank Vision Fund.", "source": "https://www.reuters.com/article/us-softbank-group-fund-saudi-idUSKBN1CT0SR" }
                    ],
                    "sources": [
                        { "title": "New York Times: Arab Investment Overseas", "url": "https://www.nytimes.com/1990/04/30/business/arab-investment-overseas-a-vast-empire.html" },

                        { "title": "Saudi PIF Official Website", "url": "https://www.pif.gov.sa/en/pages/homepage.aspx" },
                        { "title": "Bloomberg: Saudi Investments", "url": "https://www.bloomberg.com/news/articles/2023-01-10/saudi-arabia-s-pif-to-invest-more-than-20-billion-locally" }
                    ]
                },
                {
                    "name": "United Arab Emirates",
                    "investments": {
                        "united_states": { "total_estimate_1995_2025": "Over $1.5 trillion, driven by sovereign wealth funds." },
                        "israel": { "total_estimate_1995_2025": "Approximately $2 billion, mostly post-2020." }
                    },
                    "key_investments": [
                        { "year": 2007, "amount": "$7.5 billion", "description": "Abu Dhabi Investment Authority (ADIA) acquired a 4.9% stake in Citigroup.", "source": "https://www.reuters.com/article/citigroup-emirates-idUSN2636967220071127" },
                        { "year": 2018, "amount": "$1.3 billion", "description": "Mubadala invested in SoftBank's Vision Fund for US tech startups.", "source": "https://www.mubadala.com/en/news/softbank-vision-fund-announces-first-major-close" },
                        { "year": 2021, "amount": "$1 billion", "description": "UAE sovereign wealth fund acquired stake in Israel's Tamar gas field.", "source": "https://www.reuters.com/business/energy/uae-fund-buys-22-stake-israels-tamar-gas-field-2021-09-15/" }
                    ],
                    "sources": [
                        { "title": "Reuters: Citigroup Investment", "url": "https://www.reuters.com/article/citigroup-emirates-idUSN2636967220071127" },
                        { "title": "ADIA Official Website", "url": "https://www.adia.ae/en" },
                        { "title": "Mubadala Official Website", "url": "https://www.mubadala.com/en" },
                        { "title": "UAE-Israel Energy Cooperation", "url": "https://www.reuters.com/business/energy/uae-fund-buys-22-stake-israels-tamar-gas-field-2021-09-15/" }
                    ]
                },
                {
                    "name": "Qatar",
                    "investments": {
                        "united_states": { "total_estimate_1995_2025": "Over $1.3 trillion, including 2025 pledge." },
                        "israel": { "total_estimate_1995_2025": "Negligible, likely under $100 million in indirect aid-related funding." }
                    },
                    "sources": [
                        { "title": "Reuters: Qatar US Investment", "url": "https://www.reuters.com/article/qatar-investment-usa-idUSKCN0RI1OK20150918" },
                        { "title": "Qatar Investment Authority", "url": "https://www.qia.qa/en/" },
                        { "title": "Qatar Airways Boeing Deal", "url": "https://www.reuters.com/business/aerospace-defense/qatar-airways-orders-25-boeing-737-max-jets-2023-06-19/" }
                    ]
                },
                {
                    "name": "Kuwait",
                    "investments": {
                        "united_states": { "total_estimate_1995_2025": "Approximately $200‚Äì$300 billion, based on KIA's global portfolio estimates." },
                        "israel": { "total_estimate_1995_2025": "None recorded." }
                    },
                    "sources": [
                        { "title": "New York Times: Arab Investment Overseas", "url": "https://www.nytimes.com/1990/04/30/business/arab-investment-overseas-a-vast-empire.html" },
                        { "title": "Kuwait Investment Authority", "url": "https://www.kia.gov.kw/en/" },
                        { "title": "Reuters: Kuwait Investments", "url": "https://www.reuters.com/business/finance/kuwait-investment-authority-posts-record-annual-profit-2023-07-26/" }
                    ]
                },
                {
                    "name": "Bahrain",
                    "investments": {
                        "united_states": { "total_estimate_1995_2025": "Approximately $5‚Äì$10 billion, limited by Bahrain's smaller economy." },
                        "israel": { "total_estimate_1995_2025": "Under $100 million, post-2020." }
                    },
                    "sources": [
                        { "title": "Mumtalakat Holdings", "url": "https://www.mumtalakat.bh/" },
                        { "title": "Reuters: Bahrain US Investment", "url": "https://www.reuters.com/article/bahrain-investment-usa-idUSKBN1A61K9" },
                        { "title": "Bahrain Economic Development Board", "url": "https://www.bahrainedb.com/" }
                    ]
                },
                {
                    "name": "Egypt",
                    "investments": {
                        "united_states": { "total_estimate_1995_2025": "Under $1 billion, primarily private sector." },
                        "israel": { "total_estimate_1995_2025": "Negligible." }
                    },
                    "sources": [
                        { "title": "Egypt Today: Investment Relations", "url": "https://www.egypttoday.com/Article/3/108421/Egypt-US-economic-relations" },
                        { "title": "US Embassy Egypt: Economic Relations", "url": "https://eg.usembassy.gov/our-relationship/policy-history/economic-relations/" }
                    ]
                },
                {
                    "name": "Jordan",
                    "investments": {
                        "united_states": { "total_estimate_1995_2025": "Under $500 million, mostly private." },
                        "israel": { "total_estimate_1995_2025": "Negligible." }
                    },
                    "sources": [
                        { "title": "Jordan Investment Commission", "url": "https://www.jic.gov.jo/en/" },
                        { "title": "US Embassy Jordan: Economic Relations", "url": "https://jo.usembassy.gov/our-relationship/policy-history/economic-relations/" }
                    ]
                }
            ]
        };

        // Initialize with embedded data
        data = complicitData;
        investmentData = investData;
        initializeVisualization();

        function initializeVisualization() {
            console.log('Initializing visualization with data:', data); // Debug log
            updateVisualization();
            setupEventListeners();
        }

        function setupEventListeners() {
            d3.select("#viewMode").on("change", function () {
                currentView = this.value;
                updateVisualization();
            });

            d3.select("#focusFilter").on("change", function () {
                currentFocus = this.value;
                updateVisualization();
            });

            d3.select("#resetView").on("click", function () {
                currentView = 'relationships';
                currentFocus = 'all';
                d3.select("#viewMode").property("value", "relationships");
                d3.select("#focusFilter").property("value", "all");
                updateVisualization();
            });

            d3.select("#themeToggle").on("click", function () {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);

                // Update button text
                d3.select(this).text(newTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode');

                // Re-render visualization with new colors
                updateVisualization();
            });

            d3.select("#debugInvestments").on("click", function () {
                console.log('=== INVESTMENT DEBUG ===');
                investmentData.countries.forEach(country => {
                    const amount = country.investments.united_states.total_estimate_1995_2025;
                    const parsed = parseInvestmentAmount(amount);
                    console.log(`${country.name}: "${amount}" -> ${parsed}B`);
                });
                console.log('=== END DEBUG ===');
            });
        }

        function processData() {
            const countries = data.countries.filter(country => {
                if (currentFocus === 'all') return true;
                if (currentFocus === 'direct') return country.ties_with_israel === 'Direct';
                if (currentFocus === 'indirect') return country.ties_with_israel === 'Indirect';
                if (currentFocus === 'abraham') {
                    return country.details.agreements.some(agreement =>
                        agreement.name === 'Abraham Accords'
                    );
                }
                return true;
            });

            // Create hierarchical structure
            const root = {
                name: "Arab Countries",
                children: []
            };

            if (currentView === 'relationships') {
                // Group by relationship types
                const directIsrael = countries.filter(c => c.ties_with_israel === 'Direct');
                const indirectIsrael = countries.filter(c => c.ties_with_israel === 'Indirect');

                if (directIsrael.length > 0) {
                    root.children.push({
                        name: "Direct Israel Ties",
                        children: directIsrael.map(country => ({
                            name: country.name,
                            data: country,
                            value: 1
                        })),
                        type: 'direct-israel'
                    });
                }

                if (indirectIsrael.length > 0) {
                    root.children.push({
                        name: "Indirect Israel Ties",
                        children: indirectIsrael.map(country => ({
                            name: country.name,
                            data: country,
                            value: 1
                        })),
                        type: 'indirect-israel'
                    });
                }
            } else if (currentView === 'investments') {
                // Group by investment levels
                const investmentLevels = {
                    high: [],
                    medium: [],
                    low: []
                };

                countries.forEach(country => {
                    const investCountry = investmentData.countries.find(c => c.name === country.name);
                    if (investCountry) {
                        const usTotal = parseInvestmentAmount(investCountry.investments.united_states.total_estimate_1995_2025);
                        console.log(`${country.name}: ${investCountry.investments.united_states.total_estimate_1995_2025} -> ${usTotal}B`);

                        if (usTotal >= 100) {
                            investmentLevels.high.push({ name: country.name, data: country, investment: usTotal, value: Math.max(1, usTotal / 100) });
                        } else if (usTotal >= 1) {
                            investmentLevels.medium.push({ name: country.name, data: country, investment: usTotal, value: Math.max(1, usTotal) });
                        } else {
                            investmentLevels.low.push({ name: country.name, data: country, investment: usTotal, value: 1 });
                        }
                    } else {
                        console.log(`${country.name}: No investment data found`);
                        investmentLevels.low.push({ name: country.name, data: country, investment: 0, value: 1 });
                    }
                });

                if (investmentLevels.high.length > 0) {
                    root.children.push({
                        name: "High Investment (>$100B)",
                        children: investmentLevels.high,
                        type: 'investment-high'
                    });
                }
                if (investmentLevels.medium.length > 0) {
                    root.children.push({
                        name: "Medium Investment ($1B-$100B)",
                        children: investmentLevels.medium,
                        type: 'investment-medium'
                    });
                }
                if (investmentLevels.low.length > 0) {
                    root.children.push({
                        name: "Low Investment (<$1B)",
                        children: investmentLevels.low,
                        type: 'investment-low'
                    });
                }
            }

            return root;
        }

        function parseInvestmentAmount(amountStr) {
            if (!amountStr) return 0;

            console.log('Parsing investment amount:', amountStr); // Debug log

            // Handle different formats: "$800 billion", "Over $1.5 trillion", "Under $1 billion", "$200‚Äì$300 billion", etc.
            const cleanStr = amountStr.toLowerCase().replace(/[,$]/g, '');

            // Handle ranges like "200‚Äì300 billion" or "5‚Äì10 billion" - take the average
            const rangeMatch = cleanStr.match(/(\d+(?:\.\d+)?)[-‚Äì](\d+(?:\.\d+)?)\s*(trillion|billion|million)/i);
            if (rangeMatch) {
                const num1 = parseFloat(rangeMatch[1]);
                const num2 = parseFloat(rangeMatch[2]);
                const avg = (num1 + num2) / 2;
                const unit = rangeMatch[3].toLowerCase();

                console.log(`Range found: ${num1}-${num2} ${unit}, average: ${avg}`);

                // Convert to billions
                if (unit === 'trillion') return avg * 1000;
                if (unit === 'billion') return avg;
                if (unit === 'million') return avg / 1000;
                return avg;
            }

            // Extract single number and unit
            const match = cleanStr.match(/(\d+(?:\.\d+)?)\s*(trillion|billion|million)/i);
            if (!match) {
                // Handle special cases
                if (cleanStr.includes('negligible') || cleanStr.includes('none')) return 0.01;
                if (cleanStr.includes('under') && cleanStr.includes('billion')) return 0.5;
                if (cleanStr.includes('under') && cleanStr.includes('million')) return 0.0005;
                return 0.1; // Default small value
            }

            const num = parseFloat(match[1]);
            const unit = match[2].toLowerCase();

            console.log(`Single value found: ${num} ${unit}`);

            // Convert to billions
            if (unit === 'trillion') return num * 1000;
            if (unit === 'billion') return num;
            if (unit === 'million') return num / 1000;

            return num; // Default to billions
        }

        function getColor(d) {
            // Get computed CSS custom property values
            const computedStyle = getComputedStyle(document.documentElement);

            if (d.data.type) {
                switch (d.data.type) {
                    case 'direct-israel':
                        return computedStyle.getPropertyValue('--direct-israel').trim();
                    case 'indirect-israel':
                        return computedStyle.getPropertyValue('--indirect-israel').trim();
                    case 'investment-high':
                        return computedStyle.getPropertyValue('--investment-high').trim();
                    case 'investment-medium':
                        return computedStyle.getPropertyValue('--investment-medium').trim();
                    case 'investment-low':
                        return computedStyle.getPropertyValue('--investment-low').trim();
                    case 'direct-us':
                        return computedStyle.getPropertyValue('--direct-us').trim();
                    case 'indirect-us':
                        return computedStyle.getPropertyValue('--indirect-us').trim();
                }
            }

            if (d.parent && d.parent.data.type) {
                const parentColor = getColor(d.parent);
                try {
                    return d3.color(parentColor).brighter(0.4).toString();
                } catch (e) {
                    return computedStyle.getPropertyValue('--primary-color').trim();
                }
            }

            return computedStyle.getPropertyValue('--primary-color').trim();
        }

        function updateVisualization() {
            const hierarchyData = processData();

            // Clear previous visualization
            svg.selectAll("*").remove();

            if (!hierarchyData.children || hierarchyData.children.length === 0) {
                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("dy", "0.35em")
                    .style("font-size", "16px")
                    .style("fill", "var(--text-secondary)")
                    .text("No data available for current filter");
                return;
            }

            // Create hierarchy
            const root = d3.hierarchy(hierarchyData)
                .sum(d => d.value || 1)
                .sort((a, b) => b.value - a.value);

            // Create partition layout
            const partition = d3.partition()
                .size([2 * Math.PI, radius]);

            partition(root);

            // Create arc generator
            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .innerRadius(d => d.y0)
                .outerRadius(d => d.y1);

            // Draw arcs
            const paths = svg.selectAll("path")
                .data(root.descendants().filter(d => d.depth > 0))
                .enter()
                .append("path")
                .attr("class", "sunburst-path")
                .attr("d", arc)
                .style("fill", getColor)
                .style("stroke", "var(--surface-color)")
                .style("stroke-width", "2px")
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
                .on("click", handleClick);

            // Add text labels
            const texts = svg.selectAll("text")
                .data(root.descendants().filter(d => d.depth > 0 && (d.x1 - d.x0) > 0.1))
                .enter()
                .append("text")
                .attr("class", "sunburst-text")
                .attr("transform", d => {
                    const angle = (d.x0 + d.x1) / 2;
                    const radius = (d.y0 + d.y1) / 2;
                    return `rotate(${(angle * 180 / Math.PI - 90)}) translate(${radius},0) rotate(${angle > Math.PI ? 180 : 0})`;
                })
                .attr("dy", "0.35em")
                .text(d => {
                    const availableWidth = (d.x1 - d.x0) * (d.y0 + d.y1) / 2;
                    return availableWidth > 50 ? d.data.name : "";
                });

            // Add center label
            svg.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .style("font-size", "16px")
                .style("font-weight", "500")
                .style("fill", "var(--primary-color)")
                .text("Arab Countries");
        }

        function handleMouseOver(event, d) {
            tooltip.style("opacity", 1);

            let content = `<div class="tooltip-title">${d.data.name}</div>`;

            if (d.data.data) {
                const country = d.data.data;
                content += `<div class="tooltip-content">`;
                content += `<strong>üáÆüá± Israel ties:</strong> <span style="color: ${country.ties_with_israel === 'Direct' ? 'var(--direct-israel)' : 'var(--indirect-israel)'};">${country.ties_with_israel}</span><br>`;
                content += `<strong>üá∫üá∏ US ties:</strong> <span style="color: var(--direct-us);">${country.ties_with_us}</span><br>`;

                if (country.details && country.details.agreements && country.details.agreements.length > 0) {
                    content += `<strong>üìã Key agreements:</strong> ${country.details.agreements.map(a => a.name).join(", ")}<br>`;
                }

                const investCountry = investmentData.countries.find(c => c.name === country.name);
                if (investCountry) {
                    content += `<strong>üí∞ US investment:</strong> ${investCountry.investments.united_states.total_estimate_1995_2025}`;
                }

                content += `<br><br><em style="color: var(--primary-color);">Click for detailed information & sources</em>`;
                content += `</div>`;
            } else if (d.data.children) {
                // Category tooltip
                content += `<div class="tooltip-content">`;
                content += `<strong>üìÇ Category:</strong> ${d.data.name}<br>`;
                content += `<strong>üèõÔ∏è Countries:</strong> ${d.data.children.length}<br>`;
                content += `<em style="color: var(--primary-color);">Click to view category details</em>`;
                content += `</div>`;
            }

            tooltip.html(content)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function handleMouseOut() {
            tooltip.style("opacity", 0);
        }

        function handleClick(event, d) {
            console.log('Clicked:', d); // Debug log

            // Handle clicks on individual countries
            if (d.data.data) {
                showCountryInfo(d.data.data);
                return;
            }

            // Handle clicks on category segments
            if (d.data.name && d.children) {
                // Show category information
                showCategoryInfo(d.data);
                return;
            }

            // Fallback - try to find country data
            if (d.data.name && !d.children) {
                // This might be a country without the nested data structure
                const countryData = data.countries.find(c => c.name === d.data.name);
                if (countryData) {
                    showCountryInfo(countryData);
                }
            }
        }

        function showCountryInfo(country) {
            console.log('Showing country info for:', country.name); // Debug log

            const investCountry = investmentData.countries.find(c => c.name === country.name);

            let html = `
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">üèõÔ∏è ${country.name}</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                    <strong style="color: var(--text-color);">ü§ù Relationship Status</strong><br>
                    <div style="margin-top: 8px;">
                        <span style="display: inline-block; margin-right: 15px;">
                            üáÆüá± Israel: <span style="color: ${country.ties_with_israel === 'Direct' ? 'var(--direct-israel)' : 'var(--indirect-israel)'}; font-weight: 500;">${country.ties_with_israel}</span>
                        </span>
                        <span style="display: inline-block;">
                            üá∫üá∏ United States: <span style="color: var(--direct-us); font-weight: 500;">${country.ties_with_us}</span>
                        </span>
                    </div>
                </div>
            `;

            if (country.details && country.details.agreements && country.details.agreements.length > 0) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                        <strong style="color: var(--text-color);">üìã Key Agreements</strong><br>
                        <div style="margin-top: 8px;">
                            ${country.details.agreements.map(agreement =>
                    `<div style="margin: 5px 0; padding: 5px 0; border-left: 3px solid var(--primary-color); padding-left: 10px;">
                                    <strong>${agreement.name}</strong> (${agreement.year})<br>
                                    <small style="color: var(--text-secondary);">${agreement.description || ''}</small>
                                </div>`
                ).join('')}
                        </div>
                    </div>
                `;
            }

            if (investCountry) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                        <strong style="color: var(--text-color);">üí∞ Investment Data (1995-2025)</strong><br>
                        <div style="margin-top: 8px;">
                            <div style="margin: 8px 0;">
                                <strong>üá∫üá∏ US Investment:</strong><br>
                                <span style="color: var(--investment-high); font-weight: 500;">${investCountry.investments.united_states.total_estimate_1995_2025}</span>
                            </div>
                `;

                if (investCountry.investments.israel &&
                    investCountry.investments.israel.total_estimate_1995_2025 !== "None recorded." &&
                    investCountry.investments.israel.total_estimate_1995_2025 !== "Negligible.") {
                    html += `
                            <div style="margin: 8px 0;">
                                <strong>üáÆüá± Israel Investment:</strong><br>
                                <span style="color: var(--investment-medium); font-weight: 500;">${investCountry.investments.israel.total_estimate_1995_2025}</span>
                            </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            if (country.details && country.details.cooperation) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                        <strong style="color: var(--text-color);">üîó Cooperation Details</strong><br>
                        <div style="margin-top: 8px;">
                            ${country.details.cooperation.israel ? `
                                <div style="margin: 8px 0;">
                                    <strong>üáÆüá± With Israel:</strong><br>
                                    <small style="color: var(--text-secondary); line-height: 1.4;">${country.details.cooperation.israel}</small>
                                </div>
                            ` : ''}
                            ${country.details.cooperation.us ? `
                                <div style="margin: 8px 0;">
                                    <strong>üá∫üá∏ With US:</strong><br>
                                    <small style="color: var(--text-secondary); line-height: 1.4;">${country.details.cooperation.us}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            if (country.details && country.details.public_sentiment) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                        <strong style="color: var(--text-color);">üìä Public Sentiment</strong><br>
                        <div style="margin-top: 8px;">
                            <small style="color: var(--text-secondary); line-height: 1.4;">${country.details.public_sentiment}</small>
                        </div>
                    </div>
                `;
            }

            // Add sources section
            if (country.details && country.details.sources && country.details.sources.length > 0) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                        <strong style="color: var(--text-color);">üîó Sources & Evidence</strong><br>
                        <div style="margin-top: 8px;">
                            ${country.details.sources.map(source => {
                    const cleanedUrl = cleanUrl(source.url);
                    const isValid = validateUrl(cleanedUrl);
                    return `<div style="margin: 8px 0;">
                                    <a href="${cleanedUrl}" target="_blank" rel="noopener noreferrer" 
                                       style="color: ${isValid ? 'var(--primary-color)' : 'var(--warning-color)'}; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 5px;">
                                        üåê ${source.title}
                                        <span style="font-size: 12px;">‚Üó</span>
                                        ${!isValid ? '<span style="font-size: 10px; color: var(--warning-color);">‚ö†Ô∏è</span>' : ''}
                                    </a>
                                </div>`;
                }).join('')}
                        </div>
                        <div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary);">
                            ‚ö†Ô∏è = Link may need verification ‚Ä¢ All URLs cleaned of malformed fragments
                        </div>
                    </div>
                `;
            }

            // Add investment sources if available
            const investCountryFull = investmentData.countries.find(c => c.name === country.name);
            if (investCountryFull && investCountryFull.sources && investCountryFull.sources.length > 0) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                        <strong style="color: var(--text-color);">üí∞ Investment Sources</strong><br>
                        <div style="margin-top: 8px;">
                            ${investCountryFull.sources.map(source => {
                    const cleanedUrl = cleanUrl(source.url);
                    const isValid = validateUrl(cleanedUrl);
                    return `<div style="margin: 8px 0;">
                                    <a href="${cleanedUrl}" target="_blank" rel="noopener noreferrer" 
                                       style="color: ${isValid ? 'var(--investment-high)' : 'var(--warning-color)'}; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 5px;">
                                        üìä ${source.title}
                                        <span style="font-size: 12px;">‚Üó</span>
                                        ${!isValid ? '<span style="font-size: 10px; color: var(--warning-color);">‚ö†Ô∏è</span>' : ''}
                                    </a>
                                </div>`;
                }).join('')}
                        </div>
                    </div>
                `;
            }

            // Add key investment details with sources
            if (investCountryFull && investCountryFull.key_investments && investCountryFull.key_investments.length > 0) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                        <strong style="color: var(--text-color);">üíº Key Investment Details</strong><br>
                        <div style="margin-top: 8px;">
                            ${investCountryFull.key_investments.map(investment =>
                    `<div style="margin: 12px 0; padding: 10px; background: var(--surface-color); border-radius: 6px; border-left: 3px solid var(--investment-medium);">
                                    <strong>${investment.year}: ${investment.amount}</strong><br>
                                    <small style="color: var(--text-secondary); line-height: 1.4;">${investment.description}</small><br>
                                    ${investment.source ? (() => {
                        const cleanedUrl = cleanUrl(investment.source);
                        const isValid = validateUrl(cleanedUrl);
                        return `<a href="${cleanedUrl}" target="_blank" rel="noopener noreferrer" 
                                           style="color: ${isValid ? 'var(--primary-color)' : 'var(--warning-color)'}; text-decoration: none; font-size: 12px; margin-top: 5px; display: inline-flex; align-items: center; gap: 3px;">
                                            üìÑ Source ‚Üó ${!isValid ? '‚ö†Ô∏è' : ''}
                                        </a>`;
                    })() : ''}
                                </div>`
                ).join('')}
                        </div>
                    </div>
                `;
            }

            d3.select("#countryInfo").html(html);
        }

        function showCategoryInfo(categoryData) {
            console.log('Showing category info for:', categoryData.name); // Debug log

            let html = `
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">üìÇ ${categoryData.name}</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                    <strong style="color: var(--text-color);">üìà Category Overview</strong><br>
                    <div style="margin-top: 8px;">
                        <p style="color: var(--text-secondary); line-height: 1.4;">
                            This category contains ${categoryData.children ? categoryData.children.length : 0} countries.
                            Click on individual country segments to view detailed information.
                        </p>
                    </div>
                </div>
            `;

            if (categoryData.children && categoryData.children.length > 0) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-variant); border-radius: 8px;">
                        <strong style="color: var(--text-color);">üèõÔ∏è Countries in this category</strong><br>
                        <div style="margin-top: 8px;">
                            ${categoryData.children.map(child =>
                    `<div style="margin: 5px 0; padding: 8px; background: var(--surface-color); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                    <strong>${child.name}</strong>
                                    ${child.data ? `<br><small style="color: var(--text-secondary);">Israel: ${child.data.ties_with_israel}, US: ${child.data.ties_with_us}</small>` : ''}
                                </div>`
                ).join('')}
                        </div>
                    </div>
                `;
            }

            d3.select("#countryInfo").html(html);
        }
    </script>
</body>

</html>