<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Atrocities - Simple Treemap</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .treemap-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }

        .treemap-rect {
            cursor: pointer;
            stroke: white;
            stroke-width: 2px;
        }

        .treemap-rect:hover {
            opacity: 0.8;
        }

        .treemap-text {
            font-size: 12px;
            font-weight: bold;
            fill: white;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
            stroke: rgba(0, 0, 0, 0.5);
            stroke-width: 0.5px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üèõÔ∏è Israel Atrocities Timeline (1996-2025)</h1>
        <p>30-year historical documentation - Equal-sized rectangles, color shows casualty scale</p>
        <div id="stats"></div>
        <div style="margin-top: 15px;">
            <a href="timeline.html" style="background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-right: 10px;">üìà View Timeline Chart</a>
            <a href="../index.html"
                style="background: #1976d2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">‚Üê
                Back to Main Hub</a>
        </div>
    </div>

    <div class="treemap-container">
        <div id="treemap"></div>
    </div>

    <div class="info-panel">
        <h3>Incident Details</h3>
        <div id="details">Click on any rectangle above to see incident details.</div>
    </div>

    <div style="margin: 20px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
        <h4 style="color: #856404; margin-top: 0;">üìä Lancet Study: Potential Under-reporting</h4>
        <p style="color: #856404; line-height: 1.6;">
            A <strong>July 2024 Lancet study</strong> suggests that the actual death toll in Gaza could be significantly higher than reported figures. 
            The study estimates that <strong>indirect deaths could push the total to 186,000 or more</strong>, accounting for deaths from 
            disease, malnutrition, and lack of medical care caused by the destruction of healthcare infrastructure.
        </p>
        <p style="color: #856404; line-height: 1.6;">
            <strong>Source:</strong> <a href="https://www.aljazeera.com/news/2024/7/8/gaza-toll-could-exceed-186000-lancet-study-says" 
            target="_blank" style="color: #856404; text-decoration: underline;">
            Al Jazeera - "Gaza toll could exceed 186,000, Lancet study says"</a>
        </p>
    </div>

    <div style="margin: 20px; padding: 20px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 8px;">
        <h4 style="color: #721c24; margin-top: 0;">‚ö†Ô∏è IMPORTANT DISCLAIMER</h4>
        <p style="color: #721c24; line-height: 1.6; margin-bottom: 15px;">
            <strong>Educational and Documentation Purpose Only:</strong> This visualization presents documented incident data 
            for educational awareness and historical documentation. All information represents human lives lost and should be 
            treated with appropriate gravity and respect.
        </p>
        <p style="color: #721c24; line-height: 1.6; margin-bottom: 15px;">
            <strong>Data Sources and Verification:</strong> All data is compiled from credible sources including UN Human Rights Council, 
            Human Rights Watch, Amnesty International, Middle East Eye, and other documented sources. 
            Users are encouraged to independently verify information and consult original sources.
        </p>
        <p style="color: #721c24; line-height: 1.6; margin-bottom: 15px;">
            <strong>Methodology Note:</strong> Different organizations may use varying methodologies for incident documentation and casualty counting. 
            This visualization aims to present documented incidents while acknowledging that the full scope of impact may be broader.
        </p>
        <p style="color: #721c24; line-height: 1.6; margin-bottom: 0;">
            <strong>Ongoing Situation:</strong> As this represents an ongoing situation, information continues to evolve. 
            This visualization aims to provide historical context and document the scale of documented incidents over time.
        </p>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const width = 1000;
        const height = 600;

        const svg = d3.select("#treemap")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("border", "1px solid #ccc");

        const tooltip = d3.select("#tooltip");

        // Load data
        d3.json("atro_israel.json").then(function (rawData) {
            console.log("Raw data:", rawData);

            if (!rawData || !rawData.atrocities) {
                console.error("No atrocities data found");
                return;
            }

            const atrocities = rawData.atrocities;
            console.log("Number of atrocities:", atrocities.length);

            // Calculate stats - handle both numbers and strings
            let totalKilled = 0;
            let totalInjured = 0;
            let unknownCount = 0;

            atrocities.forEach(incident => {
                if (incident.casualties) {
                    const killed = incident.casualties.killed;
                    const injured = incident.casualties.injured;
                    
                    // Handle killed casualties
                    if (typeof killed === 'number') {
                        totalKilled += killed;
                    } else if (typeof killed === 'string' && killed.toLowerCase().includes('unknown')) {
                        unknownCount++;
                    }
                    
                    // Handle injured casualties  
                    if (typeof injured === 'number') {
                        totalInjured += injured;
                    } else if (typeof injured === 'string' && !injured.toLowerCase().includes('unknown')) {
                        // Try to extract numbers from strings like "Tens of thousands"
                        const match = injured.match(/(\d+)/);
                        if (match) {
                            totalInjured += parseInt(match[1]);
                        }
                    }
                }
            });

            document.getElementById("stats").innerHTML = `
                <strong>${atrocities.length} incidents documented (1996-2025) | 
                ${totalKilled.toLocaleString()}+ killed | 
                ${totalInjured.toLocaleString()}+ injured
                ${unknownCount > 0 ? ` | ${unknownCount} incidents with incomplete data` : ''}</strong>
            `;

            // Prepare data for treemap - EQUAL SIZE FOR ALL INCIDENTS
            const treeData = {
                name: "root",
                children: atrocities.map(incident => ({
                    name: incident.incident,
                    value: 1, // Equal size for all incidents
                    data: incident
                }))
            };

            console.log("Tree data:", treeData);

            // Create hierarchy
            const root = d3.hierarchy(treeData)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);

            // Create treemap
            d3.treemap()
                .size([width, height])
                .padding(2)
                (root);

            console.log("Treemap created, leaves:", root.leaves().length);

            // Color scale based on actual casualties for coloring
            const maxCasualties = d3.max(atrocities, d => {
                if (d.casualties && typeof d.casualties.killed === 'number') {
                    return d.casualties.killed;
                }
                return 0;
            });
            console.log("Max casualties:", maxCasualties);

            // Use a better color scale with more contrast
            const colorScale = d3.scaleSequential()
                .domain([1, maxCasualties])
                .interpolator(d3.interpolateRgb("#ff6b6b", "#8b0000")); // Light red to dark red

            // Draw rectangles
            const leaves = svg.selectAll("g")
                .data(root.leaves())
                .enter().append("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            leaves.append("rect")
                .attr("class", "treemap-rect")
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => {
                    const casualties = d.data.data.casualties ? d.data.data.casualties.killed : 0;
                    // Handle both numbers and strings
                    if (typeof casualties === 'number') {
                        return colorScale(Math.max(1, casualties));
                    } else {
                        // Use a neutral color for unknown data
                        return "#666666";
                    }
                })
                .on("mouseover", function (event, d) {
                    tooltip.style("opacity", 1)
                        .html(`
                            <strong>${d.data.name}</strong><br>
                            Date: ${d.data.data.date}<br>
                            Location: ${d.data.data.location}<br>
                            Killed: ${(() => {
                                const casualties = d.data.data.casualties ? d.data.data.casualties.killed : null;
                                if (typeof casualties === 'number') {
                                    return casualties.toLocaleString();
                                } else if (typeof casualties === 'string') {
                                    return casualties;
                                } else {
                                    return "Data pending";
                                }
                            })()}
                        `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function () {
                    tooltip.style("opacity", 0);
                })
                .on("click", function (event, d) {
                    showDetails(d.data.data);
                });

            // Add text labels with better contrast
            leaves.append("text")
                .attr("class", "treemap-text")
                .attr("x", 4)
                .attr("y", 14)
                .style("fill", "white")
                .style("font-weight", "bold")
                .style("text-shadow", "2px 2px 4px rgba(0,0,0,0.9)")
                .text(d => {
                    const width = d.x1 - d.x0;
                    if (width < 60) return "";
                    const name = d.data.name;
                    return width < 120 ? name.substring(0, 10) + "..." : name;
                });

            // Add casualty numbers with better contrast
            leaves.append("text")
                .attr("class", "treemap-text")
                .attr("x", 4)
                .attr("y", 28)
                .style("font-size", "10px")
                .style("fill", "white")
                .style("font-weight", "bold")
                .style("text-shadow", "2px 2px 4px rgba(0,0,0,0.9)")
                .text(d => {
                    const width = d.x1 - d.x0;
                    const height = d.y1 - d.y0;
                    if (width < 80 || height < 35) return "";
                    
                    const casualties = d.data.data.casualties ? d.data.data.casualties.killed : null;
                    
                    if (typeof casualties === 'number') {
                        return `${casualties.toLocaleString()} killed`;
                    } else if (typeof casualties === 'string') {
                        if (casualties.toLowerCase().includes('unknown')) {
                            return "Unknown casualties";
                        } else {
                            return casualties.length > 15 ? casualties.substring(0, 15) + "..." : casualties;
                        }
                    } else {
                        return "Data pending";
                    }
                });

            console.log("Visualization complete");

        }).catch(error => {
            console.error("Error loading data:", error);
            document.getElementById("treemap").innerHTML = `
                <div style="text-align: center; padding: 50px; color: red;">
                    <h3>Error loading data</h3>
                    <p>${error.message}</p>
                </div>
            `;
        });

        function showDetails(incident) {
            let html = `<h3>${incident.incident}</h3>`;
            html += `<p><strong>Date:</strong> ${incident.date}</p>`;
            html += `<p><strong>Location:</strong> ${incident.location}</p>`;
            html += `<p><strong>Description:</strong> ${incident.description}</p>`;

            if (incident.casualties) {
                html += `<h4>Casualties:</h4><ul>`;
                if (incident.casualties.killed) html += `<li>Killed: ${incident.casualties.killed.toLocaleString()}</li>`;
                if (incident.casualties.injured) html += `<li>Injured: ${incident.casualties.injured.toLocaleString()}</li>`;
                if (incident.casualties.children_killed) html += `<li>Children killed: ${incident.casualties.children_killed.toLocaleString()}</li>`;
                html += `</ul>`;
            }

            document.getElementById("details").innerHTML = html;
        }
    </script>
</body>

</html>