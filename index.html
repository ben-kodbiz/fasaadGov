<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US Atrocities Treemap - Interactive Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      /* Light theme colors */
      --primary-color: #1976d2;
      --primary-light: #42a5f5;
      --primary-dark: #1565c0;
      --secondary-color: #dc004e;
      --background-color: #fafafa;
      --surface-color: #ffffff;
      --surface-variant: #f5f5f5;
      --on-surface: #1c1b1f;
      --on-surface-variant: #49454f;
      --outline: #79747e;
      --shadow: rgba(0, 0, 0, 0.12);
      --shadow-dark: rgba(0, 0, 0, 0.24);

      /* Treemap colors - softer, more accessible */
      --color-middle-east: #e57373;
      --color-latin-america: #ffb74d;
      --color-africa: #81c784;
      --color-asia: #ba68c8;
      --color-europe: #64b5f6;
      --color-native-americans: #ff8a65;
      --color-black-people: #8d6e63;
      --color-latinos: #ffcc02;
      --color-asians: #ce93d8;
      --color-women: #f06292;
      --color-workers: #a1887f;
      --color-children: #ffab40;
      --color-prisoners: #90a4ae;
      --color-religious: #aed581;
      --color-pervasive: #ef5350;
      --color-israel: #ff7043;
      --color-news: #42a5f5;
    }

    [data-theme="dark"] {
      /* Dark theme colors */
      --background-color: #121212;
      --surface-color: #1e1e1e;
      --surface-variant: #2d2d2d;
      --on-surface: #e6e1e5;
      --on-surface-variant: #cac4d0;
      --outline: #938f99;
      --shadow: rgba(0, 0, 0, 0.3);
      --shadow-dark: rgba(0, 0, 0, 0.5);

      /* Darker, more muted treemap colors for dark mode */
      --color-middle-east: #c62828;
      --color-latin-america: #ef6c00;
      --color-africa: #2e7d32;
      --color-asia: #7b1fa2;
      --color-europe: #1976d2;
      --color-native-americans: #d84315;
      --color-black-people: #5d4037;
      --color-latinos: #f57f17;
      --color-asians: #8e24aa;
      --color-women: #c2185b;
      --color-workers: #6d4c41;
      --color-children: #ff8f00;
      --color-prisoners: #546e7a;
      --color-religious: #689f38;
      --color-pervasive: #d32f2f;
      --color-israel: #e64a19;
      --color-news: #1976d2;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--on-surface);
      transition: background-color 0.3s ease, color 0.3s ease;
      line-height: 1.6;
    }

    .app-bar {
      background: var(--surface-color);
      box-shadow: 0 2px 4px var(--shadow);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: 500;
      margin: 0;
      color: var(--primary-color);
    }

    .app-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: none;
      border-radius: 20px;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      box-shadow: 0 2px 8px var(--shadow-dark);
      transform: translateY(-1px);
    }

    .btn-icon {
      background: transparent;
      color: var(--on-surface-variant);
      border: 1px solid var(--outline);
      padding: 8px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: var(--surface-variant);
      color: var(--on-surface);
    }

    .controls-container {
      background: var(--surface-color);
      margin: 24px;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 200px;
    }

    .control-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--on-surface-variant);
    }

    .select {
      padding: 12px 16px;
      border: 1px solid var(--outline);
      border-radius: 8px;
      background: var(--surface-color);
      color: var(--on-surface);
      font-family: inherit;
      font-size: 0.875rem;
      transition: border-color 0.2s ease;
    }

    .select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }

    .chart-container {
      margin: 24px;
      background: var(--surface-color);
      border-radius: 12px;
      box-shadow: 0 1px 3px var(--shadow);
      overflow: hidden;
      resize: vertical;
      min-height: 400px;
    }

    #chart {
      position: relative;
      width: 100%;
      height: 600px;
      background: var(--surface-variant);
      overflow: hidden;
      min-height: 400px;
    }

    .node {
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5), 0 0 1px rgba(255, 255, 255, 0.3);
    }

    .node:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px var(--shadow-dark);
      z-index: 10;
      border-color: rgba(255, 255, 255, 0.4);
    }

    .tooltip {
      position: absolute;
      background: var(--surface-color);
      color: var(--on-surface);
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 16px var(--shadow-dark);
      pointer-events: none;
      font-size: 0.875rem;
      max-width: 300px;
      z-index: 1000;
      border: 1px solid var(--outline);
    }

    .tooltip-title {
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--primary-color);
    }

    .tooltip-meta {
      font-size: 0.75rem;
      color: var(--on-surface-variant);
      margin-bottom: 8px;
    }

    .tooltip-description {
      line-height: 1.4;
    }

    .legend-container {
      margin: 24px;
      background: var(--surface-color);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .legend-title {
      font-size: 1.125rem;
      font-weight: 500;
      margin-bottom: 16px;
      color: var(--on-surface);
    }

    .legend-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }

    .legend-item:hover {
      background: var(--surface-variant);
    }

    .legend-color {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      box-shadow: 0 1px 2px var(--shadow);
    }

    .legend-label {
      font-size: 0.875rem;
      font-weight: 400;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--on-surface-variant);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--surface-variant);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--secondary-color);
      text-align: center;
      padding: 24px;
    }

    .error-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    /* Mobile-first responsive design */
    @media (max-width: 768px) {
      .app-bar {
        padding: 12px 16px;
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }

      .app-title {
        font-size: 1.25rem;
      }

      .controls-container,
      .chart-container,
      .legend-container {
        margin: 8px;
        padding: 16px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }

      .control-group {
        min-width: auto;
      }

      #chart {
        height: 70vh;
        /* Use viewport height for better mobile experience */
        min-height: 400px;
      }

      .node {
        font-size: 0.7rem;
        font-weight: 500;
        min-width: 40px !important;
        min-height: 30px !important;
        border-width: 2px;
      }

      .legend-items {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .legend-item {
        padding: 12px;
        border-radius: 8px;
        background: var(--surface-variant);
      }

      .legend-color {
        width: 20px;
        height: 20px;
      }

      .tooltip {
        max-width: 90vw;
        font-size: 0.8rem;
        padding: 12px;
      }
    }

    /* Extra small screens (phones in portrait) */
    @media (max-width: 480px) {
      .app-title {
        font-size: 1.1rem;
      }

      .controls-container,
      .chart-container,
      .legend-container {
        margin: 4px;
        padding: 12px;
      }

      #chart {
        height: 60vh;
        min-height: 350px;
      }

      .node {
        font-size: 0.65rem;
        min-width: 35px !important;
        min-height: 25px !important;
        padding: 2px;
      }

      .btn {
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      .select {
        padding: 10px 12px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <div class="app-bar">
    <h1 class="app-title">🗺️ US Atrocities Treemap</h1>
    <div class="app-actions">
      <a href="upload.html" class="btn btn-primary">
        <span class="material-icons">upload</span>
        Upload Articles
      </a>
      <button class="btn btn-icon" id="refreshData" title="Refresh data">
        <span class="material-icons">refresh</span>
      </button>
      <button class="btn btn-icon" id="themeToggle" title="Toggle dark mode">
        <span class="material-icons">dark_mode</span>
      </button>
    </div>
  </div>

  <div class="controls-container">
    <div class="controls">
      <div class="control-group">
        <label class="control-label">Search Events</label>
        <input type="text" id="searchInput" class="select" placeholder="Search by title or description..." style="padding: 12px 16px;">
      </div>
      <div class="control-group">
        <label class="control-label">Filter by Type</label>
        <select id="typeFilter" class="select">
          <option value="All">All Events</option>
          <option value="markdown">Historical Data</option>
          <option value="news_article">News Articles</option>
        </select>
      </div>
      <div class="control-group">
        <label class="control-label">Filter by Category</label>
        <select id="regionFilter" class="select">
          <option value="All">All Categories</option>
          <option value="Middle East">Middle East</option>
          <option value="Western hemisphere">Western Hemisphere</option>
          <option value="Africa">Africa</option>
          <option value="Asia">Asia</option>
          <option value="Europe">Europe</option>
          <option value="Native Americans">Native Americans</option>
          <option value="Black people">Black People</option>
          <option value="Latinos">Latinos</option>
          <option value="Asians">Asians</option>
          <option value="Women">Women</option>
          <option value="Workers and the Poor">Workers and the Poor</option>
          <option value="Children">Children</option>
          <option value="Prisoners">Prisoners</option>
          <option value="Religious minorities">Religious Minorities</option>
          <option value="Pervasive">Pervasive</option>
          <option value="Israel Atrocities">Israel Atrocities</option>
        </select>
      </div>
      <div class="control-group" id="mobileViewToggle" style="display: none;">
        <label class="control-label">Mobile View</label>
        <select id="viewMode" class="select">
          <option value="treemap">Treemap View</option>
          <option value="list">List View</option>
        </select>
      </div>
    </div>
  </div>

  <div class="chart-container">
    <div id="chart">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>Loading treemap data...</div>
      </div>
    </div>
  </div>

  <div class="legend-container">
    <h3 class="legend-title">Categories</h3>
    <div id="legend-items" class="legend-items"></div>
  </div>

  <script>
    // Theme management
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = themeToggle.querySelector('.material-icons');

    // Check for saved theme or default to light
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    });

    function updateThemeIcon(theme) {
      themeIcon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
    }

    // Add refresh data functionality
    document.getElementById('refreshData').addEventListener('click', () => {
      console.log("Manual data refresh triggered");
      location.reload(true); // Force reload from server
    });

    // Mobile detection and view mode
    const isMobile = () => window.innerWidth <= 768;
    let currentViewMode = 'treemap';

    // Show mobile view toggle on mobile devices
    if (isMobile()) {
      document.getElementById('mobileViewToggle').style.display = 'block';
    }

    // D3.js visualization
    const chartElement = document.getElementById("chart");
    let width = chartElement.clientWidth;
    let height = 600;
    const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

    // Enhanced D3.js features
    let currentZoomLevel = null;
    let zoomHistory = [];
    const dispatch = d3.dispatch("update", "zoom", "filter");

    // Color scale with improved accessibility
    const colorScale = d3.scaleOrdinal()
      .domain([
        "Middle East", "Western hemisphere", "Africa", "Asia", "Europe",
        "Native Americans", "Black people", "Latinos", "Asians", "Women",
        "Workers and the Poor", "Children", "Prisoners", "Religious minorities",
        "Pervasive", "Israel Atrocities"
      ])
      .range(d3.schemeTableau10.concat(d3.schemeDark2));

    // Function to get current dimensions
    function getCurrentDimensions() {
      const rect = chartElement.getBoundingClientRect();
      const containerWidth = Math.max(rect.width, 300); // Minimum width
      const containerHeight = isMobile() ?
        Math.min(window.innerHeight * 0.6, 500) :
        Math.max(Math.min(window.innerHeight * 0.7, 800), 400); // Responsive height

      return {
        width: containerWidth,
        height: containerHeight
      };
    }

    // Observer to watch for container size changes
    if (window.ResizeObserver) {
      const resizeObserver = new ResizeObserver(entries => {
        if (rawData && entries.length > 0) {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            filterData();
          }, 100);
        }
      });
      resizeObserver.observe(chartElement);
    }

    let rawData;

    // Enhanced color mapping function with D3 color scales
    function getCategoryColor(category) {
      const colorMap = {
        "Middle East": "var(--color-middle-east)",
        "Western hemisphere": "var(--color-latin-america)",
        "Africa": "var(--color-africa)",
        "Asia": "var(--color-asia)",
        "Europe": "var(--color-europe)",
        "Native Americans": "var(--color-native-americans)",
        "Black people": "var(--color-black-people)",
        "Latinos": "var(--color-latinos)",
        "Asians": "var(--color-asians)",
        "Women": "var(--color-women)",
        "Workers and the Poor": "var(--color-workers)",
        "Children": "var(--color-children)",
        "Prisoners": "var(--color-prisoners)",
        "Religious minorities": "var(--color-religious)",
        "Pervasive": "var(--color-pervasive)",
        "Israel Atrocities": "var(--color-israel)"
      };
      return colorMap[category] || "var(--color-news)";
    }

    // Enhanced severity-based color scaling
    function getSeverityColor(casualties, category) {
      if (!casualties || casualties === 0) {
        return getCategoryColor(category);
      }
      
      const baseColor = getCategoryColor(category);
      const severity = Math.min(casualties / 1000, 1); // Normalize to 0-1
      
      // Create a darker shade for higher casualties
      const hsl = d3.hsl(baseColor.replace('var(', '').replace(')', ''));
      hsl.l = Math.max(0.3, hsl.l - (severity * 0.3)); // Darken based on severity
      return hsl.toString();
    }

    // Dynamic text sizing based on node dimensions
    function calculateFontSize(width, height, textLength) {
      const area = width * height;
      const baseSize = Math.sqrt(area) / 8;
      const lengthFactor = Math.max(0.5, 1 - (textLength / 50));
      return Math.max(8, Math.min(16, baseSize * lengthFactor));
    }

    // Enhanced text color calculation for better readability
    function getOptimalTextColor(category, casualties = 0) {
      // Categories that need white text (darker backgrounds)
      const whiteTextCategories = [
        "Black people",
        "Prisoners", 
        "Workers and the Poor",
        "Middle East",
        "Africa",
        "Asia",
        "Pervasive",
        "Israel Atrocities",
        "Europe",  // Dark blue background
        "Western hemisphere",  // Orange background
        "Native Americans",  // Orange-red background
        "Women"  // Pink background
      ];
      
      // Categories that need dark text (lighter backgrounds)  
      const darkTextCategories = [
        "Latinos",  // Bright yellow background
        "Children",  // Light orange background
        "Religious minorities",  // Light green background
        "Asians"  // Light purple background
      ];
      
      // High casualty events get darker backgrounds, so use white text
      if (casualties > 500) {
        return "white";
      }
      
      // Check category-specific text color needs
      if (whiteTextCategories.includes(category)) {
        return "white";
      }
      
      if (darkTextCategories.includes(category)) {
        return "rgba(0, 0, 0, 0.87)";
      }
      
      // Default to white text for safety (most colors tend to be darker)
      return "white";
    }

    const renderListView = (data) => {
      d3.select("#chart").selectAll("*").remove();

      if (!data || data.length === 0) {
        d3.select("#chart").html(`
          <div class="error">
            <div class="error-icon">📊</div>
            <div>No data available for the selected filters</div>
          </div>
        `);
        return;
      }

      const container = d3.select("#chart")
        .style("height", "auto")
        .style("padding", "16px")
        .style("overflow-y", "auto")
        .style("max-height", "70vh");

      // Performance optimization: limit initial render for large datasets
      const totalEvents = data.reduce((sum, cat) => sum + cat.children.length, 0);
      const shouldPaginate = totalEvents > 100;
      let displayedEvents = 0;
      const maxInitialEvents = 50;

      data.forEach(category => {
        if (shouldPaginate && displayedEvents >= maxInitialEvents) return;

        const categoryDiv = container.append("div")
          .style("margin-bottom", "24px")
          .style("background", "var(--surface-color)")
          .style("border-radius", "8px")
          .style("padding", "16px")
          .style("box-shadow", "0 1px 3px var(--shadow)");

        categoryDiv.append("h3")
          .style("margin", "0 0 12px 0")
          .style("color", "var(--primary-color)")
          .style("font-size", "1.1rem")
          .text(`${category.name} (${category.children.length} events)`);

        const eventsList = categoryDiv.append("div");

        const eventsToShow = shouldPaginate ? 
          category.children.slice(0, Math.max(1, maxInitialEvents - displayedEvents)) : 
          category.children;

        eventsToShow.forEach(event => {
          const eventDiv = eventsList.append("div")
            .style("padding", "12px")
            .style("margin-bottom", "8px")
            .style("background", "var(--surface-variant)")
            .style("border-radius", "6px")
            .style("border-left", `4px solid var(${getCategoryColor(category.name).replace('var(', '').replace(')', '')})`)
            .style("cursor", "pointer")
            .style("transition", "all 0.2s ease")
            .on("click", () => showEventDetails(event))
            .on("mouseover", function() {
              d3.select(this).style("background", "var(--primary-color)")
                .style("color", "white");
            })
            .on("mouseout", function() {
              d3.select(this).style("background", "var(--surface-variant)")
                .style("color", "var(--on-surface)");
            });

          eventDiv.append("div")
            .style("font-weight", "500")
            .style("margin-bottom", "4px")
            .text(event.title || event.name);

          const metaDiv = eventDiv.append("div")
            .style("font-size", "0.8rem")
            .style("color", "var(--on-surface-variant)")
            .style("margin-bottom", "8px");

          let metaInfo = [];
          if (event.date) metaInfo.push(`📅 ${event.date}`);
          if (event.casualties || event.estimated_deaths) {
            const casualties = event.casualties || event.estimated_deaths;
            metaInfo.push(`💀 ${casualties.toLocaleString()} casualties`);
          }
          metaInfo.push(`🏷️ ${event.type === "news_article" ? "News" : "Historical"}`);

          metaDiv.text(metaInfo.join(" • "));

          if (event.summary || event.description) {
            const description = event.summary || event.description;
            eventDiv.append("div")
              .style("font-size", "0.85rem")
              .style("line-height", "1.4")
              .style("color", "var(--on-surface)")
              .text(description.length > 150 ? description.substring(0, 150) + "..." : description);
          }
        });

        displayedEvents += eventsToShow.length;

        // Add "Show more" button if there are more events
        if (shouldPaginate && eventsToShow.length < category.children.length) {
          const showMoreBtn = eventsList.append("div")
            .style("text-align", "center")
            .style("margin-top", "12px");

          showMoreBtn.append("button")
            .style("background", "var(--primary-color)")
            .style("color", "white")
            .style("border", "none")
            .style("padding", "8px 16px")
            .style("border-radius", "20px")
            .style("cursor", "pointer")
            .style("font-size", "0.875rem")
            .text(`Show ${category.children.length - eventsToShow.length} more events`)
            .on("click", function() {
              // Expand this category
              eventsList.selectAll("*").remove();
              category.children.forEach(event => {
                // Re-render all events for this category
                const eventDiv = eventsList.append("div")
                  .style("padding", "12px")
                  .style("margin-bottom", "8px")
                  .style("background", "var(--surface-variant)")
                  .style("border-radius", "6px")
                  .style("border-left", `4px solid var(${getCategoryColor(category.name).replace('var(', '').replace(')', '')})`)
                  .style("cursor", "pointer")
                  .on("click", () => showEventDetails(event));

                eventDiv.append("div")
                  .style("font-weight", "500")
                  .style("margin-bottom", "4px")
                  .text(event.title || event.name);

                const metaDiv = eventDiv.append("div")
                  .style("font-size", "0.8rem")
                  .style("color", "var(--on-surface-variant)")
                  .style("margin-bottom", "8px");

                let metaInfo = [];
                if (event.date) metaInfo.push(`📅 ${event.date}`);
                if (event.casualties || event.estimated_deaths) {
                  const casualties = event.casualties || event.estimated_deaths;
                  metaInfo.push(`💀 ${casualties.toLocaleString()} casualties`);
                }
                metaInfo.push(`🏷️ ${event.type === "news_article" ? "News" : "Historical"}`);

                metaDiv.text(metaInfo.join(" • "));

                if (event.summary || event.description) {
                  const description = event.summary || event.description;
                  eventDiv.append("div")
                    .style("font-size", "0.85rem")
                    .style("line-height", "1.4")
                    .style("color", "var(--on-surface)")
                    .text(description.length > 150 ? description.substring(0, 150) + "..." : description);
                }
              });
            });
        }
      });

      // Show pagination info if applicable
      if (shouldPaginate && displayedEvents < totalEvents) {
        container.append("div")
          .style("text-align", "center")
          .style("margin-top", "24px")
          .style("padding", "16px")
          .style("background", "var(--surface-variant)")
          .style("border-radius", "8px")
          .style("color", "var(--on-surface-variant)")
          .html(`Showing ${displayedEvents} of ${totalEvents} events. Use search or filters to narrow results.`);
      }
    };

    // Enhanced zoom and drill-down functionality
    function zoomToCategory(categoryData) {
      currentZoomLevel = categoryData;
      zoomHistory.push(categoryData);
      
      // Create zoom view with just this category's events
      const zoomedData = [{
        name: categoryData.name,
        category: categoryData.category,
        children: categoryData.children
      }];
      
      renderTreemap(zoomedData, true);
      showBackButton();
    }

    function zoomOut() {
      if (zoomHistory.length > 0) {
        zoomHistory.pop();
        currentZoomLevel = zoomHistory.length > 0 ? zoomHistory[zoomHistory.length - 1] : null;
        
        if (currentZoomLevel) {
          zoomToCategory(currentZoomLevel);
        } else {
          hideBackButton();
          filterData(); // Return to full view
        }
      }
    }

    function showBackButton() {
      let backButton = d3.select("#backButton");
      if (backButton.empty()) {
        backButton = d3.select("#chart")
          .append("div")
          .attr("id", "backButton")
          .style("position", "absolute")
          .style("top", "10px")
          .style("left", "10px")
          .style("z-index", "1000")
          .style("background", "var(--primary-color)")
          .style("color", "white")
          .style("padding", "8px 16px")
          .style("border-radius", "20px")
          .style("cursor", "pointer")
          .style("font-size", "0.875rem")
          .style("font-weight", "500")
          .style("box-shadow", "0 2px 8px var(--shadow-dark)")
          .style("transition", "all 0.2s ease")
          .text("← Back to Overview")
          .on("click", zoomOut)
          .on("mouseover", function() {
            d3.select(this).style("transform", "translateY(-1px)");
          })
          .on("mouseout", function() {
            d3.select(this).style("transform", "translateY(0)");
          });
      }
    }

    function hideBackButton() {
      d3.select("#backButton").remove();
    }

    const render = (data) => {
      if (currentViewMode === 'list' && isMobile()) {
        renderListView(data);
        return;
      }

      renderTreemap(data, false);
    }

    const renderTreemap = (data, isZoomed = false) => {
      // Update dimensions on each render
      const dimensions = getCurrentDimensions();
      width = dimensions.width;
      height = dimensions.height;

      d3.select("#chart").selectAll("*").remove();
      d3.select("#chart")
        .style("height", height + "px")
        .style("padding", "0")
        .style("width", "100%");

      if (!data || data.length === 0) {
        d3.select("#chart").html(`
          <div class="error">
            <div class="error-icon">📊</div>
            <div>No data available for the selected filters</div>
          </div>
        `);
        return;
      }

      const root = d3.hierarchy({ name: "US Atrocities", children: data })
        .sum(d => {
          const casualties = d.casualties || d.estimated_deaths || 0;
          if (casualties === 0) return 1;
          const cappedCasualties = Math.min(casualties, 10000);
          return Math.log10(cappedCasualties + 1) + 1;
        })
        .sort((a, b) => b.value - a.value);

      // Enhanced treemap with better padding
      const treemap = d3.treemap()
        .size([width, height])
        .paddingInner(isZoomed ? 3 : 2)
        .paddingOuter(isZoomed ? 5 : 3)
        .paddingTop(isZoomed ? 30 : 3); // Extra space for back button when zoomed

      treemap(root);

      // Enhanced node rendering with animations and improved interactions
      const chart = d3.select("#chart")
        .selectAll("div")
        .data(root.leaves())
        .join(
          enter => enter.append("div")
            .attr("class", "node")
            .style("opacity", 0)
            .style("transform", "scale(0.8)")
            .call(enter => enter.transition()
              .duration(750)
              .ease(d3.easeCubicOut)
              .style("opacity", 1)
              .style("transform", "scale(1)")
            ),
          update => update
            .call(update => update.transition()
              .duration(500)
              .ease(d3.easeCubicInOut)
            ),
          exit => exit
            .call(exit => exit.transition()
              .duration(300)
              .style("opacity", 0)
              .style("transform", "scale(0.8)")
              .remove()
            )
        )
        .style("left", d => d.x0 + "px")
        .style("top", d => d.y0 + "px")
        .style("width", d => {
          const nodeWidth = d.x1 - d.x0;
          const isMobile = window.innerWidth <= 768;
          return Math.max(nodeWidth, isMobile ? 35 : 20) + "px";
        })
        .style("height", d => {
          const nodeHeight = d.y1 - d.y0;
          const isMobile = window.innerWidth <= 768;
          return Math.max(nodeHeight, isMobile ? 25 : 15) + "px";
        })
        .style("background", d => {
          const category = d.parent.data.name || d.parent.data.category;
          const casualties = d.data.casualties || d.data.estimated_deaths || 0;
          
          // Use severity-based coloring if casualties are available
          if (casualties > 0) {
            return getSeverityColor(casualties, category);
          }
          
          const color = getCategoryColor(category);
          return `var(${color.replace('var(', '').replace(')', '')})`;
        })
        .style("color", d => {
          const category = d.parent.data.name || d.parent.data.category;
          const casualties = d.data.casualties || d.data.estimated_deaths || 0;
          
          // Use enhanced text color calculation
          return getOptimalTextColor(category, casualties);
        })
        .style("font-size", d => {
          const nodeWidth = d.x1 - d.x0;
          const nodeHeight = d.y1 - d.y0;
          const title = d.data.title || d.data.name || "";
          return calculateFontSize(nodeWidth, nodeHeight, title.length) + "px";
        })
        .text(d => {
          const title = d.data.title || d.data.name;
          const nodeWidth = d.x1 - d.x0;
          const nodeHeight = d.y1 - d.y0;
          const isMobile = window.innerWidth <= 768;

          // More lenient text display on mobile
          const minWidth = isMobile ? 35 : 50;
          const minHeight = isMobile ? 25 : 20;

          if (nodeWidth < minWidth || nodeHeight < minHeight) return "";

          // Dynamic text truncation based on node size
          const maxLength = Math.floor(nodeWidth / 8);
          if (title && title.length > maxLength) {
            return title.substring(0, maxLength) + "...";
          }
          return title || "";
        })
        .on("click", (event, d) => {
          event.stopPropagation();
          
          // If we're not zoomed and this is a category with multiple events, zoom in
          if (!isZoomed && d.parent.data.children && d.parent.data.children.length > 1) {
            const categoryData = {
              name: d.parent.data.name || d.parent.data.category,
              category: d.parent.data.name || d.parent.data.category,
              children: d.parent.data.children
            };
            zoomToCategory(categoryData);
          } else {
            // Show detailed modal or sidebar for individual events
            showEventDetails(d.data);
          }
        })
        .on("mousemove", (event, d) => {
          tooltip.transition().duration(200).style("opacity", 1);

          const isNewsArticle = d.data.type === "news_article";
          const title = d.data.title || d.data.name;
          const date = d.data.date || d.data.year;
          const deaths = d.data.casualties || d.data.estimated_deaths;
          const region = d.parent.data.category || d.parent.data.name;
          const type = d.data.type || "Historical";
          const description = d.data.summary || d.data.description;
          const source = d.data.source;

          let tooltipContent = `<div class="tooltip-title">${title}</div>`;

          let metaInfo = [];
          if (date) metaInfo.push(`📅 ${date}`);
          if (deaths) metaInfo.push(`💀 ${deaths.toLocaleString()} casualties`);
          metaInfo.push(`📂 ${region}`);
          metaInfo.push(`🏷️ ${isNewsArticle ? "News Article" : type}`);

          tooltipContent += `<div class="tooltip-meta">${metaInfo.join(" • ")}</div>`;

          if (description) {
            const shortDesc = description.length > 200 ? description.substring(0, 200) + "..." : description;
            tooltipContent += `<div class="tooltip-description">${shortDesc}</div>`;
          }

          if (source) {
            tooltipContent += `<div class="tooltip-meta" style="margin-top: 8px;"><em>Source: ${source}</em></div>`;
          }

          // Add click hint for zoomable categories
          if (!isZoomed && d.parent.data.children && d.parent.data.children.length > 1) {
            tooltipContent += `<div class="tooltip-meta" style="margin-top: 8px; color: var(--primary-color);"><strong>Click to zoom into ${region}</strong></div>`;
          } else {
            tooltipContent += `<div class="tooltip-meta" style="margin-top: 8px; color: var(--primary-color);"><strong>Click for details</strong></div>`;
          }

          tooltip.html(tooltipContent)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 10) + "px");
        })
        .on("mouseout", () => {
          tooltip.transition().duration(300).style("opacity", 0);
        });

      // Show back button if zoomed
      if (isZoomed) {
        showBackButton();
      }

      updateLegend(data);
      
      // Add accessibility features after rendering
      setTimeout(addAccessibilityFeatures, 100);
    }

    // Enhanced event details modal
    function showEventDetails(eventData) {
      // Remove existing modal if present
      d3.select("#eventModal").remove();

      const modal = d3.select("body")
        .append("div")
        .attr("id", "eventModal")
        .style("position", "fixed")
        .style("top", "0")
        .style("left", "0")
        .style("width", "100%")
        .style("height", "100%")
        .style("background", "rgba(0, 0, 0, 0.5)")
        .style("display", "flex")
        .style("align-items", "center")
        .style("justify-content", "center")
        .style("z-index", "2000")
        .style("opacity", "0")
        .on("click", function(event) {
          if (event.target === this) closeEventModal();
        });

      const modalContent = modal.append("div")
        .style("background", "var(--surface-color)")
        .style("color", "var(--on-surface)")
        .style("border-radius", "12px")
        .style("padding", "24px")
        .style("max-width", "600px")
        .style("max-height", "80vh")
        .style("overflow-y", "auto")
        .style("margin", "20px")
        .style("box-shadow", "0 8px 32px var(--shadow-dark)")
        .style("transform", "scale(0.9)")
        .on("click", function(event) {
          event.stopPropagation();
        });

      // Modal header
      const header = modalContent.append("div")
        .style("display", "flex")
        .style("justify-content", "space-between")
        .style("align-items", "flex-start")
        .style("margin-bottom", "16px");

      header.append("h2")
        .style("margin", "0")
        .style("color", "var(--primary-color)")
        .style("font-size", "1.5rem")
        .style("line-height", "1.3")
        .text(eventData.title || eventData.name);

      header.append("button")
        .style("background", "none")
        .style("border", "none")
        .style("font-size", "1.5rem")
        .style("cursor", "pointer")
        .style("color", "var(--on-surface-variant)")
        .style("padding", "4px")
        .text("×")
        .on("click", closeEventModal);

      // Event metadata
      const metadata = modalContent.append("div")
        .style("margin-bottom", "16px")
        .style("padding", "12px")
        .style("background", "var(--surface-variant)")
        .style("border-radius", "8px");

      const metaItems = [];
      if (eventData.date) metaItems.push(`📅 Date: ${eventData.date}`);
      if (eventData.casualties || eventData.estimated_deaths) {
        const casualties = eventData.casualties || eventData.estimated_deaths;
        metaItems.push(`💀 Casualties: ${casualties.toLocaleString()}`);
      }
      if (eventData.region) metaItems.push(`🌍 Region: ${eventData.region}`);
      metaItems.push(`🏷️ Type: ${eventData.type === "news_article" ? "News Article" : "Historical Event"}`);

      metaItems.forEach(item => {
        metadata.append("div")
          .style("margin-bottom", "4px")
          .style("font-size", "0.9rem")
          .text(item);
      });

      // Event description
      if (eventData.summary || eventData.description) {
        modalContent.append("h3")
          .style("margin", "16px 0 8px 0")
          .style("font-size", "1.1rem")
          .text("Description");

        modalContent.append("div")
          .style("line-height", "1.6")
          .style("margin-bottom", "16px")
          .text(eventData.summary || eventData.description);
      }

      // Source information
      if (eventData.source) {
        modalContent.append("h3")
          .style("margin", "16px 0 8px 0")
          .style("font-size", "1.1rem")
          .text("Source");

        const sourceDiv = modalContent.append("div")
          .style("margin-bottom", "16px");

        if (eventData.sourceUrl) {
          sourceDiv.append("a")
            .attr("href", eventData.sourceUrl)
            .attr("target", "_blank")
            .style("color", "var(--primary-color)")
            .style("text-decoration", "none")
            .text(eventData.source)
            .on("mouseover", function() {
              d3.select(this).style("text-decoration", "underline");
            })
            .on("mouseout", function() {
              d3.select(this).style("text-decoration", "none");
            });
        } else {
          sourceDiv.text(eventData.source);
        }
      }

      // Animate modal in
      modal.transition()
        .duration(300)
        .ease(d3.easeCubicOut)
        .style("opacity", "1");

      modalContent.transition()
        .duration(300)
        .ease(d3.easeCubicOut)
        .style("transform", "scale(1)");
    }

    function closeEventModal() {
      const modal = d3.select("#eventModal");
      if (!modal.empty()) {
        modal.transition()
          .duration(200)
          .style("opacity", "0")
          .on("end", function() {
            modal.remove();
          });
      }
    }

    // Enhanced keyboard navigation and accessibility
    document.addEventListener("keydown", function(event) {
      if (event.key === "Escape") {
        closeEventModal();
        
        // Also zoom out if we're in a zoomed view
        if (currentZoomLevel) {
          zoomOut();
        }
      }
      
      // Quick search focus with Ctrl+F or Cmd+F
      if ((event.ctrlKey || event.metaKey) && event.key === "f") {
        event.preventDefault();
        document.getElementById("searchInput").focus();
      }
    });

    // Add ARIA labels and keyboard support to nodes
    function addAccessibilityFeatures() {
      d3.selectAll(".node")
        .attr("tabindex", "0")
        .attr("role", "button")
        .attr("aria-label", d => {
          const title = d.data.title || d.data.name;
          const category = d.parent.data.name || d.parent.data.category;
          const casualties = d.data.casualties || d.data.estimated_deaths;
          let label = `${title} in ${category}`;
          if (casualties) label += `, ${casualties} casualties`;
          return label;
        })
        .on("keydown", function(event, d) {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            // Trigger the same action as click
            const clickEvent = new MouseEvent("click", {
              bubbles: true,
              cancelable: true,
              view: window
            });
            this.dispatchEvent(clickEvent);
          }
        });
    }

    const updateLegend = (data) => {
      const legendItems = d3.select("#legend-items");
      legendItems.selectAll("*").remove();

      const categories = [...new Set(data.map(d => d.category || d.name))];

      categories.forEach(category => {
        const color = getCategoryColor(category);
        const item = legendItems.append("div")
          .attr("class", "legend-item");

        item.append("div")
          .attr("class", "legend-color")
          .style("background", `var(${color.replace('var(', '').replace(')', '')})`);

        item.append("span")
          .attr("class", "legend-label")
          .text(category);
      });
    }

    // Load and process data with aggressive cache busting
    const cacheBreaker = Date.now() + Math.random();
    console.log("Loading data with cache breaker:", cacheBreaker);
    
    d3.json("data/us_interventions.json?v=" + cacheBreaker).then(function (data) {
      console.log("Data loaded successfully. Categories:", data.categories?.length || "unknown");
      
      // Log total casualties for debugging
      let totalCasualties = 0;
      if (data.categories) {
        data.categories.forEach(cat => {
          cat.events.forEach(event => {
            totalCasualties += (event.casualties || event.estimated_deaths || 0);
          });
        });
        console.log("Total casualties calculated:", totalCasualties.toLocaleString());
      }
      rawData = data.categories || data;

      function filterData() {
        const selectedType = document.getElementById("typeFilter").value;
        const selectedRegion = document.getElementById("regionFilter").value;
        const searchQuery = document.getElementById("searchInput").value.toLowerCase().trim();

        let filtered = rawData.map(group => {
          const regionMatch = selectedRegion === "All" || group.name === selectedRegion || group.category === selectedRegion;
          if (!regionMatch) return null;

          const filteredEvents = group.events.filter(e => {
            // Type filter
            const typeMatch = selectedType === "All" || e.type === selectedType;
            
            // Search filter
            let searchMatch = true;
            if (searchQuery) {
              const title = (e.title || e.name || "").toLowerCase();
              const summary = (e.summary || e.description || "").toLowerCase();
              const source = (e.source || "").toLowerCase();
              searchMatch = title.includes(searchQuery) || 
                           summary.includes(searchQuery) || 
                           source.includes(searchQuery);
            }
            
            return typeMatch && searchMatch;
          });

          return filteredEvents.length ? {
            name: group.name || group.category,
            category: group.name || group.category,
            children: filteredEvents
          } : null;
        }).filter(Boolean);

        render(filtered);
        
        // Update statistics
        updateStatistics(filtered);
      }

      // Add statistics display
      function updateStatistics(data) {
        let existingStats = d3.select("#statistics");
        if (existingStats.empty()) {
          existingStats = d3.select(".controls-container")
            .append("div")
            .attr("id", "statistics")
            .style("margin-top", "16px")
            .style("padding", "12px")
            .style("background", "var(--surface-variant)")
            .style("border-radius", "8px")
            .style("font-size", "0.875rem")
            .style("color", "var(--on-surface-variant)");
        }

        const totalEvents = data.reduce((sum, category) => sum + category.children.length, 0);
        const totalCategories = data.length;
        const totalCasualties = data.reduce((sum, category) => 
          sum + category.children.reduce((catSum, event) => 
            catSum + (event.casualties || event.estimated_deaths || 0), 0), 0);

        existingStats.html(`
          📊 <strong>${totalEvents}</strong> events across <strong>${totalCategories}</strong> categories
          ${totalCasualties > 0 ? ` • 💀 <strong>${totalCasualties.toLocaleString()}</strong> total casualties` : ''}
        `);
      }

      document.getElementById("typeFilter").addEventListener("change", filterData);
      document.getElementById("regionFilter").addEventListener("change", filterData);

      // Enhanced search with debouncing
      let searchTimeout;
      document.getElementById("searchInput").addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          filterData();
        }, 300); // Debounce search for better performance
      });

      // Clear search on Escape key
      document.getElementById("searchInput").addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          e.target.value = "";
          filterData();
        }
      });

      // View mode change handler
      const viewModeSelect = document.getElementById("viewMode");
      if (viewModeSelect) {
        viewModeSelect.addEventListener("change", (e) => {
          currentViewMode = e.target.value;
          filterData();
        });
      }

      filterData(); // Initial render
    }).catch(function (error) {
      console.error("Error loading data:", error);
      d3.select("#chart").html(`
        <div class="error">
          <div class="error-icon">⚠️</div>
          <div>Error loading treemap data</div>
          <div style="font-size: 0.875rem; margin-top: 8px; opacity: 0.7;">
            Please check that the data file exists and is properly formatted.
          </div>
        </div>
      `);
    });

    // Handle window resize and mobile detection
    // Debounced resize handler for better performance
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Show/hide mobile view toggle based on screen size
        const mobileToggle = document.getElementById('mobileViewToggle');
        if (mobileToggle) {
          mobileToggle.style.display = isMobile() ? 'block' : 'none';
        }

        // Reset to treemap view on desktop
        if (!isMobile() && currentViewMode === 'list') {
          currentViewMode = 'treemap';
          const viewModeSelect = document.getElementById("viewMode");
          if (viewModeSelect) viewModeSelect.value = 'treemap';
        }

        // Re-render with new dimensions
        if (rawData) {
          filterData();
        }
      }, 250); // Debounce resize events
    });

    // Handle orientation change on mobile devices
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (rawData) {
          filterData();
        }
      }, 500); // Wait for orientation change to complete
    });
  </script>
</body>

</html>